<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Propensity Score - 2&nbsp; 匹配（Matching）</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./stratification.html" rel="next">
<link href="./PSM.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./PropensityScore.html">倾向性评分</a></li><li class="breadcrumb-item"><a href="./matching.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">匹配（Matching）</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Propensity Score</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">推荐阅读</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./PropensityScore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">倾向性评分</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PSM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">PSM</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matching.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">匹配（Matching）</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stratification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">分层（Stratification）</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./weighting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">加权</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SensitivityAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">敏感性分析</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#matchitmatchit" id="toc-matchitmatchit" class="nav-link active" data-scroll-target="#matchitmatchit"><span class="header-section-number">2.1</span> <code>Matchit::matchit()</code></a></li>
  <li><a href="#matchingmatch" id="toc-matchingmatch" class="nav-link" data-scroll-target="#matchingmatch"><span class="header-section-number">2.2</span> <code>Matching::Match()</code></a></li>
  <li><a href="#%E5%8C%B9%E9%85%8D%E7%AE%97%E6%B3%95" id="toc-匹配算法" class="nav-link" data-scroll-target="#%E5%8C%B9%E9%85%8D%E7%AE%97%E6%B3%95"><span class="header-section-number">2.3</span> 匹配算法</a></li>
  <li>
<a href="#%E6%A1%88%E4%BE%8B1" id="toc-案例1" class="nav-link" data-scroll-target="#%E6%A1%88%E4%BE%8B1"><span class="header-section-number">2.4</span> 案例1</a>
  <ul>
<li><a href="#%E4%BC%B0%E8%AE%A1%E5%80%BE%E5%90%91%E5%BE%97%E5%88%86%E6%9A%B4%E9%9C%B2%E5%BB%BA%E6%A8%A1" id="toc-估计倾向得分暴露建模" class="nav-link" data-scroll-target="#%E4%BC%B0%E8%AE%A1%E5%80%BE%E5%90%91%E5%BE%97%E5%88%86%E6%9A%B4%E9%9C%B2%E5%BB%BA%E6%A8%A1"><span class="header-section-number">2.4.1</span> 估计倾向得分：暴露建模</a></li>
  <li>
<a href="#%E5%8C%B9%E9%85%8D" id="toc-匹配" class="nav-link" data-scroll-target="#%E5%8C%B9%E9%85%8D"><span class="header-section-number">2.4.2</span> 匹配</a>
  <ul class="collapse">
<li><a href="#%E5%8C%B9%E9%85%8D%E7%BB%93%E6%9E%9C" id="toc-匹配结果" class="nav-link" data-scroll-target="#%E5%8C%B9%E9%85%8D%E7%BB%93%E6%9E%9C"><span class="header-section-number">2.4.2.1</span> 匹配结果</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%B9%B3%E8%A1%A1%E8%AF%8A%E6%96%AD" id="toc-平衡诊断" class="nav-link" data-scroll-target="#%E5%B9%B3%E8%A1%A1%E8%AF%8A%E6%96%AD"><span class="header-section-number">2.4.3</span> 平衡诊断</a>
  <ul class="collapse">
<li><a href="#tableone" id="toc-tableone" class="nav-link" data-scroll-target="#tableone"><span class="header-section-number">2.4.3.1</span> tableone</a></li>
  <li><a href="#%E9%87%8D%E5%8F%A0" id="toc-重叠" class="nav-link" data-scroll-target="#%E9%87%8D%E5%8F%A0"><span class="header-section-number">2.4.3.2</span> 重叠</a></li>
  </ul>
</li>
  <li>
<a href="#%E4%BC%B0%E8%AE%A1%E5%9B%A0%E6%9E%9C%E6%95%88%E5%BA%94%E7%BB%93%E5%B1%80%E5%BB%BA%E6%A8%A1" id="toc-估计因果效应结局建模" class="nav-link" data-scroll-target="#%E4%BC%B0%E8%AE%A1%E5%9B%A0%E6%9E%9C%E6%95%88%E5%BA%94%E7%BB%93%E5%B1%80%E5%BB%BA%E6%A8%A1"><span class="header-section-number">2.4.4</span> 估计因果效应：结局建模</a>
  <ul class="collapse">
<li><a href="#%E8%AE%A1%E7%AE%97att" id="toc-计算att" class="nav-link" data-scroll-target="#%E8%AE%A1%E7%AE%97att"><span class="header-section-number">2.4.4.1</span> 计算ATT</a></li>
  </ul>
</li>
  <li><a href="#%E6%95%8F%E6%84%9F%E6%80%A7%E5%88%86%E6%9E%90" id="toc-敏感性分析" class="nav-link" data-scroll-target="#%E6%95%8F%E6%84%9F%E6%80%A7%E5%88%86%E6%9E%90"><span class="header-section-number">2.4.5</span> 敏感性分析</a></li>
  </ul>
</li>
  <li><a href="#matchit%E4%B8%8Ematch" id="toc-matchit与match" class="nav-link" data-scroll-target="#matchit%E4%B8%8Ematch"><span class="header-section-number">2.5</span> matchIt()与Match()</a></li>
  <li>
<a href="#matching" id="toc-matching" class="nav-link" data-scroll-target="#matching"><span class="header-section-number">2.6</span> Matching</a>
  <ul>
<li><a href="#%E4%B8%80%E5%AF%B9%E4%B8%80%E5%8C%B9%E9%85%8Datt" id="toc-一对一匹配att" class="nav-link" data-scroll-target="#%E4%B8%80%E5%AF%B9%E4%B8%80%E5%8C%B9%E9%85%8Datt"><span class="header-section-number">2.6.1</span> 一对一匹配ATT</a></li>
  <li><a href="#%E5%8C%B9%E9%85%8Date" id="toc-匹配ate" class="nav-link" data-scroll-target="#%E5%8C%B9%E9%85%8Date"><span class="header-section-number">2.6.2</span> 1:1 匹配ATE</a></li>
  <li><a href="#k-%E5%8C%B9%E9%85%8D-att" id="toc-k-匹配-att" class="nav-link" data-scroll-target="#k-%E5%8C%B9%E9%85%8D-att"><span class="header-section-number">2.6.3</span> 1:k 匹配 （ATT）</a></li>
  <li><a href="#genetic-matching" id="toc-genetic-matching" class="nav-link" data-scroll-target="#genetic-matching"><span class="header-section-number">2.6.4</span> Genetic Matching</a></li>
  <li>
<a href="#match%E7%89%88" id="toc-match版" class="nav-link" data-scroll-target="#match%E7%89%88"><span class="header-section-number">2.6.5</span> <code>Match()</code>版</a>
  <ul class="collapse">
<li><a href="#%E5%80%BE%E5%90%91%E5%8C%B9%E9%85%8D" id="toc-倾向匹配" class="nav-link" data-scroll-target="#%E5%80%BE%E5%90%91%E5%8C%B9%E9%85%8D"><span class="header-section-number">2.6.5.1</span> 倾向匹配</a></li>
  <li><a href="#%E5%B9%B3%E8%A1%A1%E8%AF%8A%E6%96%AD-1" id="toc-平衡诊断-1" class="nav-link" data-scroll-target="#%E5%B9%B3%E8%A1%A1%E8%AF%8A%E6%96%AD-1"><span class="header-section-number">2.6.5.2</span> 平衡诊断</a></li>
  <li><a href="#overlap" id="toc-overlap" class="nav-link" data-scroll-target="#overlap"><span class="header-section-number">2.6.5.3</span> overlap</a></li>
  <li><a href="#%E5%85%B1%E5%90%8C%E6%94%AF%E6%8C%81%E5%9F%9F%E7%9A%84%E6%9F%A5%E9%AA%8C" id="toc-共同支持域的查验" class="nav-link" data-scroll-target="#%E5%85%B1%E5%90%8C%E6%94%AF%E6%8C%81%E5%9F%9F%E7%9A%84%E6%9F%A5%E9%AA%8C"><span class="header-section-number">2.6.5.4</span> 共同支持域的查验</a></li>
  <li><a href="#%E6%95%8F%E6%84%9F%E6%80%A7%E5%88%86%E6%9E%90-1" id="toc-敏感性分析-1" class="nav-link" data-scroll-target="#%E6%95%8F%E6%84%9F%E6%80%A7%E5%88%86%E6%9E%90-1"><span class="header-section-number">2.6.5.5</span> 敏感性分析</a></li>
  </ul>
</li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./PropensityScore.html">倾向性评分</a></li><li class="breadcrumb-item"><a href="./matching.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">匹配（Matching）</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">2</span>&nbsp; <span class="chapter-title">匹配（Matching）</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p><strong>倾向评分匹配</strong>根据他们的倾向评分将治疗组中的每个人与对照组中的个体相匹配。对于每个人来说，倾向得分可以直观地视为从一系列协变量（和潜在混杂因素confounding）计算出来的最近治疗的概率。两个人，一个来自治疗组，一个来自对照组，如果他们的倾向评分之间的差异很小，则被认为是匹配的。不匹配的参与者将被丢弃。</p>
<p><a href="https://www.ncbi.nlm.nih.gov/core/lw/2.0/html/tileshop_pmc/tileshop_pmc_inline.html?title=Click%20on%20image%20to%20zoom&amp;p=PMC3&amp;id=8246231_atm-09-09-812-f2.jpg"><img src="images/clipboard-2383062141.png" class="img-fluid"></a></p>
<section id="matchitmatchit" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="matchitmatchit">
<span class="header-section-number">2.1</span> <code>Matchit::matchit()</code>
</h2>
<p>快速且易用</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"nearest"</span><span class="op">)</span></span>
<span><span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'optimal'</span><span class="op">)</span></span>
<span><span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'full'</span><span class="op">)</span></span>
<span><span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'quick'</span><span class="op">)</span></span>
<span><span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'genetic'</span><span class="op">)</span></span>
<span><span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'exact'</span><span class="op">)</span></span>
<span><span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'subclass'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="matchingmatch" class="level2" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="matchingmatch">
<span class="header-section-number">2.2</span> <code>Matching::Match()</code>
</h2>
<p>完全控制匹配过程</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">Matching</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y <span class="op">=</span> ,</span>
<span>                Tr <span class="op">=</span> , </span>
<span>                X <span class="op">=</span> , </span>
<span>                estimand <span class="op">=</span> , </span>
<span>                caliper <span class="op">=</span> , </span>
<span>                replace <span class="op">=</span> </span>
<span>                    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="匹配算法" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="匹配算法">
<span class="header-section-number">2.3</span> 匹配算法</h2>
<p>最近邻匹配</p>
<p>全局匹配</p>
<p>最优匹配</p>
<p>CEM</p>
<p>卡尔玛诺夫斯基（caliper，卡尺）匹配</p>
<p>匹配比例 ratio</p>
</section><section id="案例1" class="level2" data-number="2.4"><h2 data-number="2.4" class="anchored" data-anchor-id="案例1">
<span class="header-section-number">2.4</span> 案例1</h2>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">lalonde</span>, package<span class="op">=</span><span class="st">'Matching'</span><span class="op">)</span></span>
<span><span class="va">lalonde</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    445 obs. of  12 variables:</span></span>
<span><span class="co">#&gt;  $ age    : int  37 22 30 27 33 22 23 32 22 33 ...</span></span>
<span><span class="co">#&gt;  $ educ   : int  11 9 12 11 8 9 12 11 16 12 ...</span></span>
<span><span class="co">#&gt;  $ black  : int  1 0 1 1 1 1 1 1 1 0 ...</span></span>
<span><span class="co">#&gt;  $ hisp   : int  0 1 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ married: int  1 0 0 0 0 0 0 0 0 1 ...</span></span>
<span><span class="co">#&gt;  $ nodegr : int  1 1 0 1 1 1 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ re74   : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ re75   : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ re78   : num  9930 3596 24910 7506 290 ...</span></span>
<span><span class="co">#&gt;  $ u74    : int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ u75    : int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ treat  : int  1 1 1 1 1 1 1 1 1 1 ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<table class="caption-top table">
<thead><tr class="header">
<th>变量名</th>
<th>描述</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>age</code></td>
<td>年龄</td>
</tr>
<tr class="even">
<td><code>educ</code></td>
<td>受教育年限</td>
</tr>
<tr class="odd">
<td><code>black</code></td>
<td>分类变量，1为黑人</td>
</tr>
<tr class="even">
<td><code>hisp</code></td>
<td>分类变量，1为西班牙裔</td>
</tr>
<tr class="odd">
<td><code>married</code></td>
<td>分类变量，1为已婚</td>
</tr>
<tr class="even">
<td><code>nodegr</code></td>
<td>分类变量，1为有高中学历证书</td>
</tr>
<tr class="odd">
<td><code>re74</code></td>
<td>1974年的收入</td>
</tr>
<tr class="even">
<td><code>re75</code></td>
<td>1975年的收入</td>
</tr>
<tr class="odd">
<td><code>re78</code></td>
<td>1978年的收入</td>
</tr>
<tr class="even">
<td><code>u74</code></td>
<td>分类变量，1为1974年收入为零</td>
</tr>
<tr class="odd">
<td><code>u75</code></td>
<td>分类变量，1为1975年收入为零</td>
</tr>
<tr class="even">
<td><code>treat</code></td>
<td>分类变量，1为实验组</td>
</tr>
</tbody>
</table>
<section id="估计倾向得分暴露建模" class="level3" data-number="2.4.1"><h3 data-number="2.4.1" class="anchored" data-anchor-id="估计倾向得分暴露建模">
<span class="header-section-number">2.4.1</span> 估计倾向得分：暴露建模</h3>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">ps_formula</span> <span class="op">&lt;-</span> <span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">age</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">educ</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span></span>
<span>    <span class="va">hisp</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegr</span> <span class="op">+</span> <span class="va">re74</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re74</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">re75</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re75</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">u74</span> <span class="op">+</span> <span class="va">u75</span></span>
<span></span>
<span><span class="va">logit_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">ps_formula</span>,</span>
<span>              data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>              family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">logit_fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="匹配" class="level3" data-number="2.4.2"><h3 data-number="2.4.2" class="anchored" data-anchor-id="匹配">
<span class="header-section-number">2.4.2</span> 匹配</h3>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 1：1最近邻匹配</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/">MatchIt</a></span><span class="op">)</span></span>
<span><span class="va">match.obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">ps_formula</span>,data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                     distance <span class="op">=</span> <span class="st">'logit'</span>, </span>
<span>                     method <span class="op">=</span> <span class="st">"nearest"</span>, </span>
<span>                     replace<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                     ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">lalonde</span><span class="op">$</span><span class="va">ps2</span> <span class="op">&lt;-</span> <span class="va">match.obj</span><span class="op">$</span><span class="va">distance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">match.obj</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;  0.1128  0.3331  0.3904  0.4157  0.4904  0.8175</span></span>
<span></span>
<span><span class="va">match.obj</span> </span>
<span><span class="co">#&gt; A matchit object</span></span>
<span><span class="co">#&gt;  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span><span class="co">#&gt;  - distance: Propensity score</span></span>
<span><span class="co">#&gt;              - estimated with logistic regression</span></span>
<span><span class="co">#&gt;  - number of obs.: 445 (original), 370 (matched)</span></span>
<span><span class="co">#&gt;  - target estimand: ATT</span></span>
<span><span class="co">#&gt;  - covariates: age, I(age^2), educ, I(educ^2), black, hisp, married, nodegr, re74, I(re74^2), re75, I(re75^2), u74, u75</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># add caliper</span></span>
<span></span>
<span></span>
<span><span class="va">logit_of_PS</span> <span class="op">&lt;-</span>  <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># 或者 logit_of_PS &lt;- log(lalonde$ps/(1-lalonde$ps))</span></span>
<span></span>
<span><span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">logit_of_PS</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.09857709</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/">MatchIt</a></span><span class="op">)</span></span>
<span><span class="va">match.obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">ps_formula</span>,data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                     distance <span class="op">=</span> <span class="st">'logit'</span>, </span>
<span>                     method <span class="op">=</span> <span class="st">"nearest"</span>, </span>
<span>                     replace<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                     ratio <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     caliper <span class="op">=</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">logit_of_PS</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">match.obj</span> </span>
<span><span class="co">#&gt; A matchit object</span></span>
<span><span class="co">#&gt;  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span><span class="co">#&gt;  - distance: Propensity score [caliper]</span></span>
<span><span class="co">#&gt;              - estimated with logistic regression</span></span>
<span><span class="co">#&gt;  - caliper: &lt;distance&gt; (0.011)</span></span>
<span><span class="co">#&gt;  - number of obs.: 445 (original), 330 (matched)</span></span>
<span><span class="co">#&gt;  - target estimand: ATT</span></span>
<span><span class="co">#&gt;  - covariates: age, I(age^2), educ, I(educ^2), black, hisp, married, nodegr, re74, I(re74^2), re75, I(re75^2), u74, u75</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="匹配结果" class="level4" data-number="2.4.2.1"><h4 data-number="2.4.2.1" class="anchored" data-anchor-id="匹配结果">
<span class="header-section-number">2.4.2.1</span> 匹配结果</h4>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match.obj</span><span class="op">$</span><span class="va">match.matrix</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rownames_to_column</span><span class="op">(</span>var <span class="op">=</span> <span class="st">"treat_unit"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>matched_unit <span class="op">=</span> <span class="va">V1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;     treat_unit matched_unit</span></span>
<span><span class="co">#&gt; 1            1          403</span></span>
<span><span class="co">#&gt; 2            2          319</span></span>
<span><span class="co">#&gt; 3            3          261</span></span>
<span><span class="co">#&gt; 4            4          254</span></span>
<span><span class="co">#&gt; 5            5          255</span></span>
<span><span class="co">#&gt; 6            6          188</span></span>
<span><span class="co">#&gt; 7            7          218</span></span>
<span><span class="co">#&gt; 8            8          279</span></span>
<span><span class="co">#&gt; 9           10          277</span></span>
<span><span class="co">#&gt; 10          11          257</span></span>
<span><span class="co">#&gt; 11          12          285</span></span>
<span><span class="co">#&gt; 12          13          317</span></span>
<span><span class="co">#&gt; 13          14          211</span></span>
<span><span class="co">#&gt; 14          15          271</span></span>
<span><span class="co">#&gt; 15          16          323</span></span>
<span><span class="co">#&gt; 16          18          186</span></span>
<span><span class="co">#&gt; 17          19          229</span></span>
<span><span class="co">#&gt; 18          20          311</span></span>
<span><span class="co">#&gt; 19          21          235</span></span>
<span><span class="co">#&gt; 20          22          371</span></span>
<span><span class="co">#&gt; 21          23          329</span></span>
<span><span class="co">#&gt; 22          24          234</span></span>
<span><span class="co">#&gt; 23          25          327</span></span>
<span><span class="co">#&gt; 24          26          386</span></span>
<span><span class="co">#&gt; 25          27          204</span></span>
<span><span class="co">#&gt; 26          28          231</span></span>
<span><span class="co">#&gt; 27          29          328</span></span>
<span><span class="co">#&gt; 28          30          339</span></span>
<span><span class="co">#&gt; 29          31          333</span></span>
<span><span class="co">#&gt; 30          33          239</span></span>
<span><span class="co">#&gt; 31          34          431</span></span>
<span><span class="co">#&gt; 32          35          253</span></span>
<span><span class="co">#&gt; 33          36          196</span></span>
<span><span class="co">#&gt; 34          37          378</span></span>
<span><span class="co">#&gt; 35          38          303</span></span>
<span><span class="co">#&gt; 36          39          267</span></span>
<span><span class="co">#&gt; 37          40          202</span></span>
<span><span class="co">#&gt; 38          42          341</span></span>
<span><span class="co">#&gt; 39          43          318</span></span>
<span><span class="co">#&gt; 40          44          260</span></span>
<span><span class="co">#&gt; 41          45          443</span></span>
<span><span class="co">#&gt; 42          46          400</span></span>
<span><span class="co">#&gt; 43          47          357</span></span>
<span><span class="co">#&gt; 44          48          344</span></span>
<span><span class="co">#&gt; 45          49          365</span></span>
<span><span class="co">#&gt; 46          50          259</span></span>
<span><span class="co">#&gt; 47          51          208</span></span>
<span><span class="co">#&gt; 48          52          293</span></span>
<span><span class="co">#&gt; 49          53          321</span></span>
<span><span class="co">#&gt; 50          54          284</span></span>
<span><span class="co">#&gt; 51          55          369</span></span>
<span><span class="co">#&gt; 52          56          334</span></span>
<span><span class="co">#&gt; 53          57          322</span></span>
<span><span class="co">#&gt; 54          59          405</span></span>
<span><span class="co">#&gt; 55          60          377</span></span>
<span><span class="co">#&gt; 56          61          305</span></span>
<span><span class="co">#&gt; 57          62          230</span></span>
<span><span class="co">#&gt; 58          63          217</span></span>
<span><span class="co">#&gt; 59          64          221</span></span>
<span><span class="co">#&gt; 60          65          300</span></span>
<span><span class="co">#&gt; 61          66          197</span></span>
<span><span class="co">#&gt; 62          67          359</span></span>
<span><span class="co">#&gt; 63          68          397</span></span>
<span><span class="co">#&gt; 64          69          393</span></span>
<span><span class="co">#&gt; 65          70          280</span></span>
<span><span class="co">#&gt; 66          71          351</span></span>
<span><span class="co">#&gt; 67          72          215</span></span>
<span><span class="co">#&gt; 68          74          256</span></span>
<span><span class="co">#&gt; 69          76          373</span></span>
<span><span class="co">#&gt; 70          77          213</span></span>
<span><span class="co">#&gt; 71          78          297</span></span>
<span><span class="co">#&gt; 72          79          252</span></span>
<span><span class="co">#&gt; 73          80          240</span></span>
<span><span class="co">#&gt; 74          81          396</span></span>
<span><span class="co">#&gt; 75          82          434</span></span>
<span><span class="co">#&gt; 76          85          209</span></span>
<span><span class="co">#&gt; 77          86          243</span></span>
<span><span class="co">#&gt; 78          87          203</span></span>
<span><span class="co">#&gt; 79          88          226</span></span>
<span><span class="co">#&gt; 80          90          413</span></span>
<span><span class="co">#&gt; 81          91          193</span></span>
<span><span class="co">#&gt; 82          92          345</span></span>
<span><span class="co">#&gt; 83          93          219</span></span>
<span><span class="co">#&gt; 84          95          282</span></span>
<span><span class="co">#&gt; 85          96          241</span></span>
<span><span class="co">#&gt; 86          97          189</span></span>
<span><span class="co">#&gt; 87          98          310</span></span>
<span><span class="co">#&gt; 88          99          220</span></span>
<span><span class="co">#&gt; 89         100          223</span></span>
<span><span class="co">#&gt; 90         101          249</span></span>
<span><span class="co">#&gt; 91         102          247</span></span>
<span><span class="co">#&gt; 92         103          283</span></span>
<span><span class="co">#&gt; 93         104          330</span></span>
<span><span class="co">#&gt; 94         105          335</span></span>
<span><span class="co">#&gt; 95         106          288</span></span>
<span><span class="co">#&gt; 96         108          346</span></span>
<span><span class="co">#&gt; 97         109          291</span></span>
<span><span class="co">#&gt; 98         110          295</span></span>
<span><span class="co">#&gt; 99         111          306</span></span>
<span><span class="co">#&gt; 100        112          390</span></span>
<span><span class="co">#&gt; 101        113          250</span></span>
<span><span class="co">#&gt; 102        114          389</span></span>
<span><span class="co">#&gt; 103        115          426</span></span>
<span><span class="co">#&gt; 104        116          422</span></span>
<span><span class="co">#&gt; 105        118          366</span></span>
<span><span class="co">#&gt; 106        119          381</span></span>
<span><span class="co">#&gt; 107        120          304</span></span>
<span><span class="co">#&gt; 108        122          379</span></span>
<span><span class="co">#&gt; 109        123          368</span></span>
<span><span class="co">#&gt; 110        125          299</span></span>
<span><span class="co">#&gt; 111        126          425</span></span>
<span><span class="co">#&gt; 112        127          409</span></span>
<span><span class="co">#&gt; 113        128          198</span></span>
<span><span class="co">#&gt; 114        129          289</span></span>
<span><span class="co">#&gt; 115        130          388</span></span>
<span><span class="co">#&gt; 116        131          192</span></span>
<span><span class="co">#&gt; 117        132          392</span></span>
<span><span class="co">#&gt; 118        133          440</span></span>
<span><span class="co">#&gt; 119        134          354</span></span>
<span><span class="co">#&gt; 120        135          433</span></span>
<span><span class="co">#&gt; 121        136          383</span></span>
<span><span class="co">#&gt; 122        137          410</span></span>
<span><span class="co">#&gt; 123        138          367</span></span>
<span><span class="co">#&gt; 124        139          276</span></span>
<span><span class="co">#&gt; 125        140          395</span></span>
<span><span class="co">#&gt; 126        141          302</span></span>
<span><span class="co">#&gt; 127        142          427</span></span>
<span><span class="co">#&gt; 128        143          407</span></span>
<span><span class="co">#&gt; 129        144          415</span></span>
<span><span class="co">#&gt; 130        146          401</span></span>
<span><span class="co">#&gt; 131        147          420</span></span>
<span><span class="co">#&gt; 132        148          406</span></span>
<span><span class="co">#&gt; 133        149          421</span></span>
<span><span class="co">#&gt; 134        150          298</span></span>
<span><span class="co">#&gt; 135        151          385</span></span>
<span><span class="co">#&gt; 136        152          435</span></span>
<span><span class="co">#&gt; 137        153          376</span></span>
<span><span class="co">#&gt; 138        154          402</span></span>
<span><span class="co">#&gt; 139        155          266</span></span>
<span><span class="co">#&gt; 140        156          438</span></span>
<span><span class="co">#&gt; 141        157          408</span></span>
<span><span class="co">#&gt; 142        158          436</span></span>
<span><span class="co">#&gt; 143        159          437</span></span>
<span><span class="co">#&gt; 144        160          216</span></span>
<span><span class="co">#&gt; 145        161          416</span></span>
<span><span class="co">#&gt; 146        162          263</span></span>
<span><span class="co">#&gt; 147        163          380</span></span>
<span><span class="co">#&gt; 148        164          414</span></span>
<span><span class="co">#&gt; 149        165          394</span></span>
<span><span class="co">#&gt; 150        166          428</span></span>
<span><span class="co">#&gt; 151        167          227</span></span>
<span><span class="co">#&gt; 152        168          370</span></span>
<span><span class="co">#&gt; 153        169          419</span></span>
<span><span class="co">#&gt; 154        172          384</span></span>
<span><span class="co">#&gt; 155        173          212</span></span>
<span><span class="co">#&gt; 156        174          430</span></span>
<span><span class="co">#&gt; 157        175          361</span></span>
<span><span class="co">#&gt; 158        176          194</span></span>
<span><span class="co">#&gt; 159        177          187</span></span>
<span><span class="co">#&gt; 160        178          418</span></span>
<span><span class="co">#&gt; 161        180          262</span></span>
<span><span class="co">#&gt; 162        181          313</span></span>
<span><span class="co">#&gt; 163        183          201</span></span>
<span><span class="co">#&gt; 164        184          423</span></span>
<span><span class="co">#&gt; 165        185          417</span></span>
<span></span>
<span><span class="va">matched.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">match.obj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">matched.data</span><span class="op">$</span><span class="va">subclass</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt;  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt;  41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt;  61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79  80 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt;  81  82  83  84  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt; 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt; 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt; 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2   2 </span></span>
<span><span class="co">#&gt; 161 162 163 164 165 </span></span>
<span><span class="co">#&gt;   2   2   2   2   2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="平衡诊断" class="level3" data-number="2.4.3"><h3 data-number="2.4.3" class="anchored" data-anchor-id="平衡诊断">
<span class="header-section-number">2.4.3</span> 平衡诊断</h3>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 散点图展示了匹配后实验组和对照组样本倾向值的分布，凸显了分布平衡与不平衡，分布缺乏重合</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">match.obj</span>,type <span class="op">=</span> <span class="st">"jitter"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<pre><code>#&gt; To identify the units, use first mouse button; to stop, use second.</code></pre>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># QQ图 展示了 匹配前（All）匹配后（Matched）的平衡情况</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">match.obj</span>,type <span class="op">=</span> <span class="st">"QQ"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-8-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-8-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-8-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 标准化平衡统计值，Std. Mean Diff.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">match.obj</span>,standardize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = ps_formula, data = lalonde, method = "nearest", </span></span>
<span><span class="co">#&gt;     distance = "logit", replace = FALSE, caliper = 0.2 * sd(logit_of_PS), </span></span>
<span><span class="co">#&gt;     ratio = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance         0.4468        0.3936          0.4533     1.2101    0.1340</span></span>
<span><span class="co">#&gt; age             25.8162       25.0538          0.1066     1.0278    0.0254</span></span>
<span><span class="co">#&gt; I(age^2)       717.3946      677.3154          0.0929     1.0115    0.0254</span></span>
<span><span class="co">#&gt; educ            10.3459       10.0885          0.1281     1.5513    0.0287</span></span>
<span><span class="co">#&gt; I(educ^2)      111.0595      104.3731          0.1701     1.6625    0.0287</span></span>
<span><span class="co">#&gt; black            0.8432        0.8269          0.0449          .    0.0163</span></span>
<span><span class="co">#&gt; hisp             0.0595        0.1077         -0.2040          .    0.0482</span></span>
<span><span class="co">#&gt; married          0.1892        0.1538          0.0902          .    0.0353</span></span>
<span><span class="co">#&gt; nodegr           0.7081        0.8346         -0.2783          .    0.1265</span></span>
<span><span class="co">#&gt; re74          2095.5740     2107.0268         -0.0023     0.7381    0.0192</span></span>
<span><span class="co">#&gt; I(re74^2) 28141433.9907 36667413.1577         -0.0747     0.5038    0.0192</span></span>
<span><span class="co">#&gt; re75          1532.0556     1266.9092          0.0824     1.0763    0.0508</span></span>
<span><span class="co">#&gt; I(re75^2) 12654752.6909 11196530.0057          0.0260     1.4609    0.0508</span></span>
<span><span class="co">#&gt; u74              0.7081        0.7500         -0.0921          .    0.0419</span></span>
<span><span class="co">#&gt; u75              0.6000        0.6846         -0.1727          .    0.0846</span></span>
<span><span class="co">#&gt;           eCDF Max</span></span>
<span><span class="co">#&gt; distance    0.2244</span></span>
<span><span class="co">#&gt; age         0.0652</span></span>
<span><span class="co">#&gt; I(age^2)    0.0652</span></span>
<span><span class="co">#&gt; educ        0.1265</span></span>
<span><span class="co">#&gt; I(educ^2)   0.1265</span></span>
<span><span class="co">#&gt; black       0.0163</span></span>
<span><span class="co">#&gt; hisp        0.0482</span></span>
<span><span class="co">#&gt; married     0.0353</span></span>
<span><span class="co">#&gt; nodegr      0.1265</span></span>
<span><span class="co">#&gt; re74        0.0471</span></span>
<span><span class="co">#&gt; I(re74^2)   0.0471</span></span>
<span><span class="co">#&gt; re75        0.1075</span></span>
<span><span class="co">#&gt; I(re75^2)   0.1075</span></span>
<span><span class="co">#&gt; u74         0.0419</span></span>
<span><span class="co">#&gt; u75         0.0846</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance         0.4290        0.4273          0.0143     1.0167    0.0066</span></span>
<span><span class="co">#&gt; age             25.6848       25.0182          0.0932     1.1134    0.0242</span></span>
<span><span class="co">#&gt; I(age^2)       709.6242      670.7394          0.0902     1.0541    0.0242</span></span>
<span><span class="co">#&gt; educ            10.2182       10.3030         -0.0422     1.0025    0.0104</span></span>
<span><span class="co">#&gt; I(educ^2)      107.5152      109.2485         -0.0441     1.0297    0.0104</span></span>
<span><span class="co">#&gt; black            0.8545        0.8606         -0.0167          .    0.0061</span></span>
<span><span class="co">#&gt; hisp             0.0667        0.0727         -0.0256          .    0.0061</span></span>
<span><span class="co">#&gt; married          0.1939        0.1758          0.0464          .    0.0182</span></span>
<span><span class="co">#&gt; nodegr           0.7636        0.7576          0.0133          .    0.0061</span></span>
<span><span class="co">#&gt; re74          1979.6859     1697.2983          0.0578     1.3407    0.0143</span></span>
<span><span class="co">#&gt; I(re74^2) 23013407.0991 17122843.1081          0.0516     1.6221    0.0143</span></span>
<span><span class="co">#&gt; re75          1499.3482     1305.7439          0.0601     1.4323    0.0285</span></span>
<span><span class="co">#&gt; I(re75^2) 12495634.7776  8859530.6884          0.0649     4.1201    0.0285</span></span>
<span><span class="co">#&gt; u74              0.7091        0.7152         -0.0133          .    0.0061</span></span>
<span><span class="co">#&gt; u75              0.6000        0.6242         -0.0495          .    0.0242</span></span>
<span><span class="co">#&gt;           eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance    0.0424          0.0207</span></span>
<span><span class="co">#&gt; age         0.0545          0.7539</span></span>
<span><span class="co">#&gt; I(age^2)    0.0545          0.7161</span></span>
<span><span class="co">#&gt; educ        0.0485          0.5486</span></span>
<span><span class="co">#&gt; I(educ^2)   0.0485          0.5332</span></span>
<span><span class="co">#&gt; black       0.0061          0.3834</span></span>
<span><span class="co">#&gt; hisp        0.0061          0.2307</span></span>
<span><span class="co">#&gt; married     0.0182          0.5416</span></span>
<span><span class="co">#&gt; nodegr      0.0061          0.2799</span></span>
<span><span class="co">#&gt; re74        0.0485          0.5952</span></span>
<span><span class="co">#&gt; I(re74^2)   0.0485          0.3175</span></span>
<span><span class="co">#&gt; re75        0.0667          0.5325</span></span>
<span><span class="co">#&gt; I(re75^2)   0.0667          0.3181</span></span>
<span><span class="co">#&gt; u74         0.0061          0.7065</span></span>
<span><span class="co">#&gt; u75         0.0242          0.4701</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           260     185</span></span>
<span><span class="co">#&gt; Matched       165     165</span></span>
<span><span class="co">#&gt; Unmatched      95      20</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="tableone" class="level4" data-number="2.4.3.1"><h4 data-number="2.4.3.1" class="anchored" data-anchor-id="tableone">
<span class="header-section-number">2.4.3.1</span> tableone</h4>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># full data</span></span>
<span></span>
<span><span class="va">baselineVars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"educ"</span>, <span class="st">"black"</span>, <span class="st">"hisp"</span>, <span class="st">"married"</span>, </span>
<span>                  <span class="st">"re74"</span>, <span class="st">"re75"</span>, <span class="st">"u74"</span>, <span class="st">"u75"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaz-yos/tableone">tableone</a></span><span class="op">)</span></span>
<span><span class="va">tab1e_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tableone/man/CreateTableOne.html">CreateTableOne</a></span><span class="op">(</span>vars <span class="op">=</span> <span class="va">baselineVars</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>, </span>
<span>                        strata <span class="op">=</span> <span class="st">"treat"</span>,</span>
<span>                        includeNA <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                        test <span class="op">=</span> <span class="cn">TRUE</span>, smd <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tab1e_full</span>, showAllLevels <span class="op">=</span> <span class="cn">FALSE</span>, smd <span class="op">=</span> <span class="cn">TRUE</span>, test <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      Stratified by treat</span></span>
<span><span class="co">#&gt;                       0                 1                 p      test SMD   </span></span>
<span><span class="co">#&gt;   n                       260               185                             </span></span>
<span><span class="co">#&gt;   age (mean (SD))       25.05 (7.06)      25.82 (7.16)     0.265       0.107</span></span>
<span><span class="co">#&gt;   educ (mean (SD))      10.09 (1.61)      10.35 (2.01)     0.135       0.141</span></span>
<span><span class="co">#&gt;   black (mean (SD))      0.83 (0.38)       0.84 (0.36)     0.649       0.044</span></span>
<span><span class="co">#&gt;   hisp (mean (SD))       0.11 (0.31)       0.06 (0.24)     0.076       0.175</span></span>
<span><span class="co">#&gt;   married (mean (SD))    0.15 (0.36)       0.19 (0.39)     0.327       0.094</span></span>
<span><span class="co">#&gt;   re74 (mean (SD))    2107.03 (5687.91) 2095.57 (4886.62)  0.982       0.002</span></span>
<span><span class="co">#&gt;   re75 (mean (SD))    1266.91 (3102.98) 1532.06 (3219.25)  0.382       0.084</span></span>
<span><span class="co">#&gt;   u74 (mean (SD))        0.75 (0.43)       0.71 (0.46)     0.326       0.094</span></span>
<span><span class="co">#&gt;   u75 (mean (SD))        0.68 (0.47)       0.60 (0.49)     0.065       0.177</span></span>
<span></span>
<span></span>
<span><span class="co"># matched data</span></span>
<span><span class="va">matched.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">match.obj</span><span class="op">)</span></span>
<span><span class="va">tab1e_matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tableone/man/CreateTableOne.html">CreateTableOne</a></span><span class="op">(</span>vars <span class="op">=</span> <span class="va">baselineVars</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">matched.data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>, </span>
<span>                        strata <span class="op">=</span> <span class="st">"treat"</span>,</span>
<span>                        includeNA <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                        test <span class="op">=</span> <span class="cn">TRUE</span>, smd <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tab1e_matched</span>, showAllLevels <span class="op">=</span> <span class="cn">FALSE</span>, smd <span class="op">=</span> <span class="cn">TRUE</span>, test <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      Stratified by treat</span></span>
<span><span class="co">#&gt;                       0                 1                 p      test SMD   </span></span>
<span><span class="co">#&gt;   n                       165               165                             </span></span>
<span><span class="co">#&gt;   age (mean (SD))       25.02 (6.72)      25.68 (7.09)     0.381       0.097</span></span>
<span><span class="co">#&gt;   educ (mean (SD))      10.30 (1.76)      10.22 (1.77)     0.663       0.048</span></span>
<span><span class="co">#&gt;   black (mean (SD))      0.86 (0.35)       0.85 (0.35)     0.875       0.017</span></span>
<span><span class="co">#&gt;   hisp (mean (SD))       0.07 (0.26)       0.07 (0.25)     0.829       0.024</span></span>
<span><span class="co">#&gt;   married (mean (SD))    0.18 (0.38)       0.19 (0.40)     0.672       0.047</span></span>
<span><span class="co">#&gt;   re74 (mean (SD))    1697.30 (3785.35) 1979.69 (4383.00)  0.532       0.069</span></span>
<span><span class="co">#&gt;   re75 (mean (SD))    1305.74 (2682.94) 1499.35 (3210.93)  0.553       0.065</span></span>
<span><span class="co">#&gt;   u74 (mean (SD))        0.72 (0.45)       0.71 (0.46)     0.904       0.013</span></span>
<span><span class="co">#&gt;   u75 (mean (SD))        0.62 (0.49)       0.60 (0.49)     0.653       0.050</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>可以获得p值来检查平衡：但不建议这样做，基于P值的平衡评估可能会受到样本量的影响</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">smd.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tableone/man/ExtractSmd.html">ExtractSmd</a></span><span class="op">(</span><span class="va">tab1e_matched</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">smd.res</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;        age educ black hisp married re74 re75  u74  u75</span></span>
<span><span class="co">#&gt; 1 vs 2 0.1 0.05  0.02 0.02    0.05 0.07 0.07 0.01 0.05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/">cobalt</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.plot.html">bal.plot</a></span><span class="op">(</span><span class="va">match.obj</span>,  </span>
<span>         var.name <span class="op">=</span> <span class="st">"distance"</span>, </span>
<span>         which <span class="op">=</span> <span class="st">"both"</span>, </span>
<span>         type <span class="op">=</span> <span class="st">"histogram"</span>,  </span>
<span>         mirror <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">match.obj</span>, un<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>        thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.1</span>, v<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Balance Measures</span></span>
<span><span class="co">#&gt;               Type Diff.Un V.Ratio.Un Diff.Adj    M.Threshold V.Ratio.Adj</span></span>
<span><span class="co">#&gt; distance  Distance  0.4533     1.2101   0.0143 Balanced, &lt;0.1      1.0167</span></span>
<span><span class="co">#&gt; age        Contin.  0.1066     1.0278   0.0932 Balanced, &lt;0.1      1.1134</span></span>
<span><span class="co">#&gt; I(age^2)   Contin.  0.0929     1.0115   0.0902 Balanced, &lt;0.1      1.0541</span></span>
<span><span class="co">#&gt; educ       Contin.  0.1281     1.5513  -0.0422 Balanced, &lt;0.1      1.0025</span></span>
<span><span class="co">#&gt; I(educ^2)  Contin.  0.1701     1.6625  -0.0441 Balanced, &lt;0.1      1.0297</span></span>
<span><span class="co">#&gt; black       Binary  0.0163          .  -0.0061 Balanced, &lt;0.1           .</span></span>
<span><span class="co">#&gt; hisp        Binary -0.0482          .  -0.0061 Balanced, &lt;0.1           .</span></span>
<span><span class="co">#&gt; married     Binary  0.0353          .   0.0182 Balanced, &lt;0.1           .</span></span>
<span><span class="co">#&gt; nodegr      Binary -0.1265          .   0.0061 Balanced, &lt;0.1           .</span></span>
<span><span class="co">#&gt; re74       Contin. -0.0023     0.7381   0.0578 Balanced, &lt;0.1      1.3407</span></span>
<span><span class="co">#&gt; I(re74^2)  Contin. -0.0747     0.5038   0.0516 Balanced, &lt;0.1      1.6221</span></span>
<span><span class="co">#&gt; re75       Contin.  0.0824     1.0763   0.0601 Balanced, &lt;0.1      1.4323</span></span>
<span><span class="co">#&gt; I(re75^2)  Contin.  0.0260     1.4609   0.0649 Balanced, &lt;0.1      4.1201</span></span>
<span><span class="co">#&gt; u74         Binary -0.0419          .  -0.0061 Balanced, &lt;0.1           .</span></span>
<span><span class="co">#&gt; u75         Binary -0.0846          .  -0.0242 Balanced, &lt;0.1           .</span></span>
<span><span class="co">#&gt;                V.Threshold</span></span>
<span><span class="co">#&gt; distance      Balanced, &lt;2</span></span>
<span><span class="co">#&gt; age           Balanced, &lt;2</span></span>
<span><span class="co">#&gt; I(age^2)      Balanced, &lt;2</span></span>
<span><span class="co">#&gt; educ          Balanced, &lt;2</span></span>
<span><span class="co">#&gt; I(educ^2)     Balanced, &lt;2</span></span>
<span><span class="co">#&gt; black                     </span></span>
<span><span class="co">#&gt; hisp                      </span></span>
<span><span class="co">#&gt; married                   </span></span>
<span><span class="co">#&gt; nodegr                    </span></span>
<span><span class="co">#&gt; re74          Balanced, &lt;2</span></span>
<span><span class="co">#&gt; I(re74^2)     Balanced, &lt;2</span></span>
<span><span class="co">#&gt; re75          Balanced, &lt;2</span></span>
<span><span class="co">#&gt; I(re75^2) Not Balanced, &gt;2</span></span>
<span><span class="co">#&gt; u74                       </span></span>
<span><span class="co">#&gt; u75                       </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance tally for mean differences</span></span>
<span><span class="co">#&gt;                    count</span></span>
<span><span class="co">#&gt; Balanced, &lt;0.1        15</span></span>
<span><span class="co">#&gt; Not Balanced, &gt;0.1     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable with the greatest mean difference</span></span>
<span><span class="co">#&gt;  Variable Diff.Adj    M.Threshold</span></span>
<span><span class="co">#&gt;       age   0.0932 Balanced, &lt;0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance tally for variance ratios</span></span>
<span><span class="co">#&gt;                  count</span></span>
<span><span class="co">#&gt; Balanced, &lt;2         8</span></span>
<span><span class="co">#&gt; Not Balanced, &gt;2     1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable with the greatest variance ratio</span></span>
<span><span class="co">#&gt;   Variable V.Ratio.Adj      V.Threshold</span></span>
<span><span class="co">#&gt;  I(re75^2)      4.1201 Not Balanced, &gt;2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample sizes</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           260     185</span></span>
<span><span class="co">#&gt; Matched       165     165</span></span>
<span><span class="co">#&gt; Unmatched      95      20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html">love.plot</a></span><span class="op">(</span><span class="va">match.obj</span>, binary <span class="op">=</span> <span class="st">"std"</span>, abs <span class="op">=</span> <span class="cn">T</span>,</span>
<span>          thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="重叠" class="level4" data-number="2.4.3.2"><h4 data-number="2.4.3.2" class="anchored" data-anchor-id="重叠">
<span class="header-section-number">2.4.3.2</span> 重叠</h4>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">ps</span> <span class="op">~</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">lalonde</span>, </span>
<span>        lwd <span class="op">=</span> <span class="fl">2</span>, ylab <span class="op">=</span> <span class="st">'ps'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/stripchart.html">stripchart</a></span><span class="op">(</span><span class="va">ps</span> <span class="op">~</span> <span class="va">treat</span>, vertical <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>           data <span class="op">=</span> <span class="va">lalonde</span>, method <span class="op">=</span> <span class="st">"jitter"</span>, </span>
<span>           add <span class="op">=</span> <span class="cn">TRUE</span>, pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">match.obj</span>, type <span class="op">=</span> <span class="st">"jitter"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<pre><code>#&gt; To identify the units, use first mouse button; to stop, use second.</code></pre>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 直方图展示了匹配前后倾向值的分布</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">match.obj</span>, type <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/">cobalt</a></span><span class="op">)</span></span>
<span><span class="va">baltab.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">match.obj</span>, data <span class="op">=</span> <span class="va">lalonde</span>, </span>
<span>                      treat <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>                      disp.v.ratio <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">baltab.res</span></span>
<span><span class="co">#&gt; Balance Measures</span></span>
<span><span class="co">#&gt;               Type Diff.Adj V.Ratio.Adj</span></span>
<span><span class="co">#&gt; distance  Distance   0.0143      1.0167</span></span>
<span><span class="co">#&gt; age        Contin.   0.0932      1.1134</span></span>
<span><span class="co">#&gt; I(age^2)   Contin.   0.0902      1.0541</span></span>
<span><span class="co">#&gt; educ       Contin.  -0.0422      1.0025</span></span>
<span><span class="co">#&gt; I(educ^2)  Contin.  -0.0441      1.0297</span></span>
<span><span class="co">#&gt; black       Binary  -0.0061           .</span></span>
<span><span class="co">#&gt; hisp        Binary  -0.0061           .</span></span>
<span><span class="co">#&gt; married     Binary   0.0182           .</span></span>
<span><span class="co">#&gt; nodegr      Binary   0.0061           .</span></span>
<span><span class="co">#&gt; re74       Contin.   0.0578      1.3407</span></span>
<span><span class="co">#&gt; I(re74^2)  Contin.   0.0516      1.6221</span></span>
<span><span class="co">#&gt; re75       Contin.   0.0601      1.4323</span></span>
<span><span class="co">#&gt; I(re75^2)  Contin.   0.0649      4.1201</span></span>
<span><span class="co">#&gt; u74         Binary  -0.0061           .</span></span>
<span><span class="co">#&gt; u75         Binary  -0.0242           .</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample sizes</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           260     185</span></span>
<span><span class="co">#&gt; Matched       165     165</span></span>
<span><span class="co">#&gt; Unmatched      95      20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">ps</span> <span class="op">~</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">matched.data</span>, </span>
<span>        lwd <span class="op">=</span> <span class="fl">2</span>, ylab <span class="op">=</span> <span class="st">'ps'</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/stripchart.html">stripchart</a></span><span class="op">(</span><span class="va">ps</span> <span class="op">~</span> <span class="va">treat</span>, vertical <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>           data <span class="op">=</span> <span class="va">matched.data</span>, method <span class="op">=</span> <span class="st">"jitter"</span>, </span>
<span>           add <span class="op">=</span> <span class="cn">TRUE</span>, pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">+</span><span class="fl">0.05</span>,<span class="fl">1</span><span class="op">-</span><span class="fl">0.05</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="估计因果效应结局建模" class="level3" data-number="2.4.4"><h3 data-number="2.4.4" class="anchored" data-anchor-id="估计因果效应结局建模">
<span class="header-section-number">2.4.4</span> 估计因果效应：结局建模</h3>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">lalonde</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span></span>
<span>    ate_weight <span class="op">=</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span><span class="va">treat</span>, <span class="va">ps</span>, estimand <span class="op">=</span> <span class="st">'ATE'</span><span class="op">)</span>,</span>
<span>    att_weight <span class="op">=</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span><span class="va">treat</span>, <span class="va">ps</span>, estimand <span class="op">=</span> <span class="st">'ATT'</span><span class="op">)</span>,</span>
<span>    atc_weight <span class="op">=</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span><span class="va">treat</span>, <span class="va">ps</span>, estimand <span class="op">=</span> <span class="st">'ATC'</span><span class="op">)</span>,</span>
<span>    atm_weight <span class="op">=</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span><span class="va">treat</span>, <span class="va">ps</span>, estimand <span class="op">=</span> <span class="st">'ATM'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">match_out</span> <span class="op">&lt;-</span> <span class="fu">Matching</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>                             Tr <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                             X <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                             caliper <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                             replace <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             estimand <span class="op">=</span> <span class="st">'ATE'</span><span class="op">)</span></span>
<span><span class="va">dat_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>treat_ps <span class="op">=</span> <span class="va">dat</span><span class="op">[</span><span class="va">match_out</span><span class="op">$</span><span class="va">index.treated</span>,<span class="op">]</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                        treat_outcome <span class="op">=</span> <span class="va">dat</span><span class="op">[</span><span class="va">match_out</span><span class="op">$</span><span class="va">index.treated</span>,<span class="op">]</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                        control_ps <span class="op">=</span> <span class="va">dat</span><span class="op">[</span><span class="va">match_out</span><span class="op">$</span><span class="va">index.control</span>,<span class="op">]</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                        control_outcome <span class="op">=</span> <span class="va">dat</span><span class="op">[</span><span class="va">match_out</span><span class="op">$</span><span class="va">index.control</span>,<span class="op">]</span><span class="op">$</span><span class="va">treat</span><span class="op">)</span></span>
<span><span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/matching_plot.html">matching_plot</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                   treatment <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                   outcome <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>                   index_treated <span class="op">=</span> <span class="va">match_out</span><span class="op">$</span><span class="va">index.treated</span>,</span>
<span>                   index_control <span class="op">=</span> <span class="va">match_out</span><span class="op">$</span><span class="va">index.control</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/briandk/granovaGG">granovaGG</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/granovaGG/man/granovagg.ds.html">granovagg.ds</a></span><span class="op">(</span><span class="va">dat_match</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'control_ps'</span>, <span class="st">'treat_ps'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>             main <span class="op">=</span> <span class="st">'Treatment vs Control'</span>, </span>
<span>             xlab <span class="op">=</span> <span class="st">'Treatment'</span>, </span>
<span>             ylab <span class="op">=</span> <span class="st">'Control'</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                 Summary Statistics</span></span>
<span><span class="co">#&gt; n                                          325.000</span></span>
<span><span class="co">#&gt; control_ps mean                              0.427</span></span>
<span><span class="co">#&gt; treat_ps mean                                0.427</span></span>
<span><span class="co">#&gt; mean(D = control_ps - treat_ps)              0.000</span></span>
<span><span class="co">#&gt; SD(D)                                        0.004</span></span>
<span><span class="co">#&gt; Effect Size                                  0.099</span></span>
<span><span class="co">#&gt; r(control_ps, treat_ps)                      0.999</span></span>
<span><span class="co">#&gt; r(control_ps + treat_ps, D)                  0.003</span></span>
<span><span class="co">#&gt; Lower 95% Confidence Interval                0.001</span></span>
<span><span class="co">#&gt; Upper 95% Confidence Interval                0.000</span></span>
<span><span class="co">#&gt; t (D-bar)                                    1.786</span></span>
<span><span class="co">#&gt; df.t                                       324.000</span></span>
<span><span class="co">#&gt; p-value (t-statistic)                        0.075</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>相关样本评估图&nbsp;（<strong>R-granovaGG？</strong>），其中每个点代表一个匹配的对。治疗观测值绘制在&nbsp;<em>x</em>&nbsp;轴上，对照观测值绘制在&nbsp;<em>y</em>&nbsp;轴上。垂直于单位线的线上的点表示差值分数的分布。置信区间为紫色，显然没有跨越单位线，表明具有统计学意义的处理效果。</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">matched.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">match.obj</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outcome_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">age</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">educ</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span></span>
<span>    <span class="va">hisp</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegr</span> <span class="op">+</span> <span class="va">re74</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re74</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">re75</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re75</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">u74</span> <span class="op">+</span> <span class="va">u75</span>,</span>
<span>    data <span class="op">=</span> <span class="va">matched.data</span>,</span>
<span>    family <span class="op">=</span> <span class="va">gaussian</span>,<span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://jtools.jacob-long.com">jtools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># cluster option</span></span>
<span><span class="fu"><a href="https://jtools.jacob-long.com/reference/summ.html">summ</a></span><span class="op">(</span><span class="va">outcome_fit</span>, rubust <span class="op">=</span> <span class="st">"HC0"</span>, confint <span class="op">=</span> <span class="cn">TRUE</span>, digists <span class="op">=</span> <span class="fl">4</span>, </span>
<span>     cluster <span class="op">=</span> <span class="st">"subclass"</span>, model.info <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>     model.fit <span class="op">=</span> <span class="cn">FALSE</span>, exp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;">
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
exp(Est.)
</th>
<th style="text-align:right;">
2.5%
</th>
<th style="text-align:right;">
97.5%
</th>
<th style="text-align:right;">
t val.
</th>
<th style="text-align:right;">
p
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
(Intercept)
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
0.65
</td>
<td style="text-align:right;">
0.52
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
treat
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
908.95
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
1.97
</td>
<td style="text-align:right;">
0.05
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
age
</td>
<td style="text-align:right;">
57405944379315703788400660660862044264660840228406628428426662484660602402446440404446040480224662262888.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
0.77
</td>
<td style="text-align:right;">
0.44
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
I(age^2)
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1097.55
</td>
<td style="text-align:right;">
-0.57
</td>
<td style="text-align:right;">
0.57
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
educ
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
-0.88
</td>
<td style="text-align:right;">
0.38
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
I(educ^2)
</td>
<td style="text-align:right;">
28541250540249301224064866446620628268480284206.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
143915694200275994966664688226486484428088222042240848428860000066822440406224048444664660888082424806228268244868428284246862.00
</td>
<td style="text-align:right;">
1.16
</td>
<td style="text-align:right;">
0.25
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
black
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
-2.83
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
hisp
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
-0.30
</td>
<td style="text-align:right;">
0.76
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
married
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
-0.32
</td>
<td style="text-align:right;">
0.75
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
nodegr
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
1.09
</td>
<td style="text-align:right;">
0.28
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
re74
</td>
<td style="text-align:right;">
1.08
</td>
<td style="text-align:right;">
0.54
</td>
<td style="text-align:right;">
2.19
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
0.82
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
I(re74^2)
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
-0.01
</td>
<td style="text-align:right;">
0.99
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
re75
</td>
<td style="text-align:right;">
1.06
</td>
<td style="text-align:right;">
0.51
</td>
<td style="text-align:right;">
2.21
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
0.87
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
I(re75^2)
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
-0.08
</td>
<td style="text-align:right;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
u74
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
Inf
</td>
<td style="text-align:right;">
1.41
</td>
<td style="text-align:right;">
0.16
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
u75
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
34315362040838099536062828422682068004060466420404684064268402662048262604282882002408242628428868064820482200060602606868064046442466008080686086842484204602466640200080.00
</td>
<td style="text-align:right;">
-1.66
</td>
<td style="text-align:right;">
0.10
</td>
</tr>
</tbody>
<tfoot><tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> Standard errors: MLE
</td>
</tr></tfoot>
</table>
</div>
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># GEE</span></span>
<span></span>
<span><span class="co"># conditional logistic</span></span>
<span></span>
<span></span>
<span><span class="co"># bootstrapping</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="计算att" class="level4" data-number="2.4.4.1"><h4 data-number="2.4.4.1" class="anchored" data-anchor-id="计算att">
<span class="header-section-number">2.4.4.1</span> 计算ATT</h4>
<p>为了简化步骤，以当前的结果进行匹配后分析。</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/iqss/clarify">"clarify"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sim_coefs</span> <span class="op">&lt;-</span> <span class="fu">clarify</span><span class="fu">::</span><span class="fu"><a href="https://iqss.github.io/clarify/reference/sim.html">sim</a></span><span class="op">(</span><span class="va">outcome_fit</span><span class="op">)</span></span>
<span><span class="va">sim_coefs</span></span>
<span><span class="co">#&gt; A `clarify_sim` object</span></span>
<span><span class="co">#&gt;  - 16 coefficients, 1000 simulated values</span></span>
<span><span class="co">#&gt;  - sampled distribution: multivariate t(314)</span></span>
<span><span class="co">#&gt;  - original fitting function call:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; glm(formula = re78 ~ treat + age + I(age^2) + educ + I(educ^2) + </span></span>
<span><span class="co">#&gt;     black + hisp + married + nodegr + re74 + I(re74^2) + re75 + </span></span>
<span><span class="co">#&gt;     I(re75^2) + u74 + u75, family = gaussian, data = matched.data)</span></span>
<span></span>
<span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://iqss.github.io/clarify/reference/sim_ame.html">sim_ame</a></span><span class="op">(</span><span class="va">sim_coefs</span>, var <span class="op">=</span> <span class="st">"treat"</span>, subset <span class="op">=</span> <span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>               contrast <span class="op">=</span> <span class="st">"rr"</span> , verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>   <span class="co"># "diff" ,sr, ar</span></span>
<span></span>
<span><span class="va">est</span></span>
<span><span class="co">#&gt; A `clarify_est` object (from `sim_ame()`)</span></span>
<span><span class="co">#&gt;  - Average adjusted predictions for `treat`</span></span>
<span><span class="co">#&gt;  - 1000 simulated values</span></span>
<span><span class="co">#&gt;  - 3 quantities estimated:                    </span></span>
<span><span class="co">#&gt;  E[Y(0)] 4537.971710</span></span>
<span><span class="co">#&gt;  E[Y(1)] 5927.974158</span></span>
<span><span class="co">#&gt;  RR         1.306305</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Estimate    2.5 %   97.5 %</span></span>
<span><span class="co">#&gt; E[Y(0)] 4537.972 3540.907 5495.420</span></span>
<span><span class="co">#&gt; E[Y(1)] 5927.974 4986.618 6940.625</span></span>
<span><span class="co">#&gt; RR         1.306    0.992    1.768</span></span>
<span></span>
<span><span class="co"># 绘制 ATT</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="敏感性分析" class="level3" data-number="2.4.5"><h3 data-number="2.4.5" class="anchored" data-anchor-id="敏感性分析">
<span class="header-section-number">2.4.5</span> 敏感性分析</h3>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 提取匹配后的样本</span></span>
<span><span class="va">mData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">match.obj</span>,group <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="va">mData_trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">match.obj</span>,group <span class="op">=</span> <span class="st">"treat"</span><span class="op">)</span></span>
<span><span class="va">mData_ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">match.obj</span>,group <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rbounds</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rbounds/man/psens.html">psens</a></span><span class="op">(</span>x <span class="op">=</span><span class="va">mData_trt</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>      y <span class="op">=</span><span class="va">mData_ctrl</span><span class="op">$</span><span class="va">re78</span> ,Gamma <span class="op">=</span> <span class="fl">2</span>,GammaInc <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Rosenbaum Sensitivity Test for Wilcoxon Signed Rank P-Value </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Unconfounded estimate ....  0.0492 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Gamma Lower bound Upper bound</span></span>
<span><span class="co">#&gt;    1.0      0.0492      0.0492</span></span>
<span><span class="co">#&gt;    1.1      0.0151      0.1264</span></span>
<span><span class="co">#&gt;    1.2      0.0042      0.2481</span></span>
<span><span class="co">#&gt;    1.3      0.0010      0.3991</span></span>
<span><span class="co">#&gt;    1.4      0.0002      0.5545</span></span>
<span><span class="co">#&gt;    1.5      0.0001      0.6925</span></span>
<span><span class="co">#&gt;    1.6      0.0000      0.8012</span></span>
<span><span class="co">#&gt;    1.7      0.0000      0.8787</span></span>
<span><span class="co">#&gt;    1.8      0.0000      0.9298</span></span>
<span><span class="co">#&gt;    1.9      0.0000      0.9611</span></span>
<span><span class="co">#&gt;    2.0      0.0000      0.9793</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Note: Gamma is Odds of Differential Assignment To</span></span>
<span><span class="co">#&gt;  Treatment Due to Unobserved Factors </span></span>
<span><span class="co">#&gt; </span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rbounds/man/hlsens.html">hlsens</a></span><span class="op">(</span>x <span class="op">=</span><span class="va">mData_trt</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>      y <span class="op">=</span><span class="va">mData_ctrl</span><span class="op">$</span><span class="va">re78</span> ,Gamma <span class="op">=</span> <span class="fl">2</span>,GammaInc <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Rosenbaum Sensitivity Test for Hodges-Lehmann Point Estimate </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Unconfounded estimate ....  1070.54 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Gamma Lower bound Upper bound</span></span>
<span><span class="co">#&gt;    1.0     1070.50      1070.5</span></span>
<span><span class="co">#&gt;    1.1      562.54      1213.7</span></span>
<span><span class="co">#&gt;    1.2      319.74      1508.4</span></span>
<span><span class="co">#&gt;    1.3       75.84      1822.9</span></span>
<span><span class="co">#&gt;    1.4     -124.56      2037.8</span></span>
<span><span class="co">#&gt;    1.5     -338.56      2233.1</span></span>
<span><span class="co">#&gt;    1.6     -541.66      2490.0</span></span>
<span><span class="co">#&gt;    1.7     -767.96      2673.4</span></span>
<span><span class="co">#&gt;    1.8     -965.76      2896.6</span></span>
<span><span class="co">#&gt;    1.9    -1124.30      3090.6</span></span>
<span><span class="co">#&gt;    2.0    -1286.60      3289.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Note: Gamma is Odds of Differential Assignment To</span></span>
<span><span class="co">#&gt;  Treatment Due to Unobserved Factors </span></span>
<span><span class="co">#&gt; </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="matchit与match" class="level2" data-number="2.5"><h2 data-number="2.5" class="anchored" data-anchor-id="matchit与match">
<span class="header-section-number">2.5</span> matchIt()与Match()</h2>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">matchit.out</span> <span class="op">&lt;-</span> <span class="fu">MatchIt</span><span class="fu">::</span><span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">ps_formula</span>, </span>
<span>                                data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                                estimand <span class="op">=</span> <span class="st">"ATT"</span> <span class="op">)</span> <span class="co">#ATC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">matchit.out</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; MatchIt::matchit(formula = ps_formula, data = lalonde, estimand = "ATT")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance         0.4468        0.3936          0.4533     1.2101    0.1340</span></span>
<span><span class="co">#&gt; age             25.8162       25.0538          0.1066     1.0278    0.0254</span></span>
<span><span class="co">#&gt; I(age^2)       717.3946      677.3154          0.0929     1.0115    0.0254</span></span>
<span><span class="co">#&gt; educ            10.3459       10.0885          0.1281     1.5513    0.0287</span></span>
<span><span class="co">#&gt; I(educ^2)      111.0595      104.3731          0.1701     1.6625    0.0287</span></span>
<span><span class="co">#&gt; black            0.8432        0.8269          0.0449          .    0.0163</span></span>
<span><span class="co">#&gt; hisp             0.0595        0.1077         -0.2040          .    0.0482</span></span>
<span><span class="co">#&gt; married          0.1892        0.1538          0.0902          .    0.0353</span></span>
<span><span class="co">#&gt; nodegr           0.7081        0.8346         -0.2783          .    0.1265</span></span>
<span><span class="co">#&gt; re74          2095.5740     2107.0268         -0.0023     0.7381    0.0192</span></span>
<span><span class="co">#&gt; I(re74^2) 28141433.9907 36667413.1577         -0.0747     0.5038    0.0192</span></span>
<span><span class="co">#&gt; re75          1532.0556     1266.9092          0.0824     1.0763    0.0508</span></span>
<span><span class="co">#&gt; I(re75^2) 12654752.6909 11196530.0057          0.0260     1.4609    0.0508</span></span>
<span><span class="co">#&gt; u74              0.7081        0.7500         -0.0921          .    0.0419</span></span>
<span><span class="co">#&gt; u75              0.6000        0.6846         -0.1727          .    0.0846</span></span>
<span><span class="co">#&gt;           eCDF Max</span></span>
<span><span class="co">#&gt; distance    0.2244</span></span>
<span><span class="co">#&gt; age         0.0652</span></span>
<span><span class="co">#&gt; I(age^2)    0.0652</span></span>
<span><span class="co">#&gt; educ        0.1265</span></span>
<span><span class="co">#&gt; I(educ^2)   0.1265</span></span>
<span><span class="co">#&gt; black       0.0163</span></span>
<span><span class="co">#&gt; hisp        0.0482</span></span>
<span><span class="co">#&gt; married     0.0353</span></span>
<span><span class="co">#&gt; nodegr      0.1265</span></span>
<span><span class="co">#&gt; re74        0.0471</span></span>
<span><span class="co">#&gt; I(re74^2)   0.0471</span></span>
<span><span class="co">#&gt; re75        0.1075</span></span>
<span><span class="co">#&gt; I(re75^2)   0.1075</span></span>
<span><span class="co">#&gt; u74         0.0419</span></span>
<span><span class="co">#&gt; u75         0.0846</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance         0.4468        0.4284          0.1571     1.3077    0.0387</span></span>
<span><span class="co">#&gt; age             25.8162       25.1351          0.0952     1.1734    0.0243</span></span>
<span><span class="co">#&gt; I(age^2)       717.3946      675.1676          0.0979     1.1512    0.0243</span></span>
<span><span class="co">#&gt; educ            10.3459       10.2649          0.0403     1.2869    0.0174</span></span>
<span><span class="co">#&gt; I(educ^2)      111.0595      108.4919          0.0653     1.3938    0.0174</span></span>
<span><span class="co">#&gt; black            0.8432        0.8486         -0.0149          .    0.0054</span></span>
<span><span class="co">#&gt; hisp             0.0595        0.0703         -0.0457          .    0.0108</span></span>
<span><span class="co">#&gt; married          0.1892        0.1892          0.0000          .    0.0000</span></span>
<span><span class="co">#&gt; nodegr           0.7081        0.7676         -0.1308          .    0.0595</span></span>
<span><span class="co">#&gt; re74          2095.5740     1741.2109          0.0725     1.5797    0.0146</span></span>
<span><span class="co">#&gt; I(re74^2) 28141433.9907 18066538.6428          0.0883     3.5436    0.0146</span></span>
<span><span class="co">#&gt; re75          1532.0556     1314.8073          0.0675     1.3933    0.0264</span></span>
<span><span class="co">#&gt; I(re75^2) 12654752.6909  9126579.7979          0.0630     3.4873    0.0264</span></span>
<span><span class="co">#&gt; u74              0.7081        0.7243         -0.0357          .    0.0162</span></span>
<span><span class="co">#&gt; u75              0.6000        0.6108         -0.0221          .    0.0108</span></span>
<span><span class="co">#&gt;           eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance    0.1189          0.1585</span></span>
<span><span class="co">#&gt; age         0.0541          0.8159</span></span>
<span><span class="co">#&gt; I(age^2)    0.0541          0.7701</span></span>
<span><span class="co">#&gt; educ        0.0595          0.7662</span></span>
<span><span class="co">#&gt; I(educ^2)   0.0595          0.7604</span></span>
<span><span class="co">#&gt; black       0.0054          0.5798</span></span>
<span><span class="co">#&gt; hisp        0.0108          0.2286</span></span>
<span><span class="co">#&gt; married     0.0000          0.2378</span></span>
<span><span class="co">#&gt; nodegr      0.0595          0.5588</span></span>
<span><span class="co">#&gt; re74        0.0432          0.6080</span></span>
<span><span class="co">#&gt; I(re74^2)   0.0432          0.3620</span></span>
<span><span class="co">#&gt; re75        0.0649          0.7292</span></span>
<span><span class="co">#&gt; I(re75^2)   0.0649          0.3690</span></span>
<span><span class="co">#&gt; u74         0.0162          0.7728</span></span>
<span><span class="co">#&gt; u75         0.0108          0.7282</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;           Control Treated</span></span>
<span><span class="co">#&gt; All           260     185</span></span>
<span><span class="co">#&gt; Matched       185     185</span></span>
<span><span class="co">#&gt; Unmatched      75       0</span></span>
<span><span class="co">#&gt; Discarded       0       0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Same as above but calculate average treatment effect</span></span>
<span><span class="va">rr.ate</span> <span class="op">&lt;-</span> <span class="fu">Match</span><span class="op">(</span>Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>, </span>
<span>                Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>                X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                M <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                ties <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                replace <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                estimand<span class="op">=</span><span class="st">'ATE'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr.ate</span><span class="op">)</span> <span class="co"># Here the estimate is ATE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2071.9 </span></span>
<span><span class="co">#&gt; SE.........  502.34 </span></span>
<span><span class="co">#&gt; T-stat.....  4.1246 </span></span>
<span><span class="co">#&gt; p.val......  3.7143e-05 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  370 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  370</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="matching" class="level2" data-number="2.6"><h2 data-number="2.6" class="anchored" data-anchor-id="matching">
<span class="header-section-number">2.6</span> Matching</h2>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JasjeetSekhon/Matching">Matching</a></span><span class="op">)</span></span>
<span><span class="va">lalonde_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>    Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>    X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>    M <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    caliper <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">'ATE'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">lalonde_match</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2053.1 </span></span>
<span><span class="co">#&gt; AI SE......  803.05 </span></span>
<span><span class="co">#&gt; T-stat.....  2.5566 </span></span>
<span><span class="co">#&gt; p.val......  0.010569 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  433 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  744 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Caliper (SDs)........................................   0.1 </span></span>
<span><span class="co">#&gt; Number of obs dropped by 'exact' or 'caliper'  12</span></span>
<span></span>
<span><span class="va">lalonde_match_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    treated.ps <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="va">lalonde_match</span><span class="op">$</span><span class="va">index.treated</span>, <span class="op">]</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>    control.ps <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="va">lalonde_match</span><span class="op">$</span><span class="va">index.control</span>, <span class="op">]</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>    treated.y <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    control.y <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lalonde_match_df</span> <span class="op">&lt;-</span> <span class="va">lalonde_match_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">lalonde_match_df</span><span class="op">$</span><span class="va">control.ps</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">rows</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">lalonde_match_df</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">lalonde_match_df</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">lalonde</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ps</span>, y <span class="op">=</span> <span class="va">treat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span></span>
<span>        method <span class="op">=</span> <span class="va">glm</span>,</span>
<span>        formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>        method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlim</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">'Propensity Score'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">'Treatment'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_segment</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">lalonde_match_df</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span></span>
<span>            x <span class="op">=</span> <span class="va">treated.ps</span>,</span>
<span>            xend <span class="op">=</span> <span class="va">control.ps</span>,</span>
<span>            y <span class="op">=</span> <span class="va">treated.y</span>,</span>
<span>            yend <span class="op">=</span> <span class="va">control.y</span></span>
<span>        <span class="op">)</span>,</span>
<span>        color <span class="op">=</span> <span class="st">'purple'</span>,</span>
<span>        alpha <span class="op">=</span> <span class="fl">0.1</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>匹配后，治疗组和对照组应具有非常相似的特征。可以使用简单的回归模型来估计治疗对结果的影响。</p>
<section id="一对一匹配att" class="level3" data-number="2.6.1"><h3 data-number="2.6.1" class="anchored" data-anchor-id="一对一匹配att">
<span class="header-section-number">2.6.1</span> 一对一匹配ATT</h3>
<p>Estimating the treatment effect on the treated (default is ATT)</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rr_att</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>, </span>
<span>                Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>                X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                M <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                estimand<span class="op">=</span><span class="st">'ATT'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr_att</span><span class="op">)</span> <span class="co"># The default estimate is ATT here</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2153.3 </span></span>
<span><span class="co">#&gt; AI SE......  825.4 </span></span>
<span><span class="co">#&gt; T-stat.....  2.6088 </span></span>
<span><span class="co">#&gt; p.val......  0.0090858 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  346</span></span>
<span></span>
<span><span class="va">rr_att_mb</span> <span class="op">&lt;-</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu">MatchBalance</span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>    formu <span class="op">=</span> <span class="va">ps_formula</span>,</span>
<span>    formu.Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.formula.html">update.formula</a></span><span class="op">(</span><span class="va">ps_formula</span>, <span class="va">re78</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span>,</span>
<span>    index.treated <span class="op">=</span> <span class="va">rr_att</span><span class="op">$</span><span class="va">index.treated</span>,</span>
<span>    index.control <span class="op">=</span> <span class="va">rr_att</span><span class="op">$</span><span class="va">index.control</span>,</span>
<span>    tolerance <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>    M <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">'ATT'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">rr_att_mb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr_att_mb</span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample sizes and number of matches:</span></span>
<span><span class="co">#&gt;    Group   n n.matched n.percent.matched</span></span>
<span><span class="co">#&gt;  Treated 185       185         1.0000000</span></span>
<span><span class="co">#&gt;  Control 260       173         0.6653846</span></span>
<span><span class="co">#&gt;    Total 445       358         0.8044944</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Covariate importance and t-tests for matched pairs:</span></span>
<span><span class="co">#&gt;           Import.Treat Import.Y Import.Total std.estimate       t p.value</span></span>
<span><span class="co">#&gt; I(educ^2)        1.931   1.5228        3.453     -0.04903 -0.8916  0.3732</span></span>
<span><span class="co">#&gt; educ             2.099   1.2121        3.311     -0.05483 -0.9577  0.3389</span></span>
<span><span class="co">#&gt; black            0.705   1.8424        2.547     -0.02326 -0.5383  0.5907</span></span>
<span><span class="co">#&gt; I(re74^2)        0.353   1.6415        1.994      0.07581  2.0955  0.0369</span></span>
<span><span class="co">#&gt; u75              0.852   0.9435        1.796     -0.06655 -1.8144  0.0705</span></span>
<span><span class="co">#&gt; hisp             1.731   0.0404        1.771      0.02042  0.8161  0.4150</span></span>
<span><span class="co">#&gt; nodegr           1.090   0.5011        1.591      0.03496  1.0914  0.2759</span></span>
<span><span class="co">#&gt; re74             0.280   1.1019        1.382      0.07979  1.7483  0.0813</span></span>
<span><span class="co">#&gt; re75             0.642   0.5903        1.232      0.06147  1.3171  0.1887</span></span>
<span><span class="co">#&gt; age              0.237   0.6729        0.910      0.00896  0.1374  0.8908</span></span>
<span><span class="co">#&gt; married          0.646   0.1406        0.787      0.04627  1.0000  0.3180</span></span>
<span><span class="co">#&gt; I(re75^2)        0.390   0.3817        0.772      0.05125  1.0364  0.3007</span></span>
<span><span class="co">#&gt; I(age^2)         0.232   0.5096        0.742      0.00297  0.0438  0.9651</span></span>
<span><span class="co">#&gt; u74              0.184   0.0702        0.254      0.03913  0.7495  0.4541</span></span>
<span><span class="co">#&gt;             ci.min  ci.max PercentMatched</span></span>
<span><span class="co">#&gt; I(educ^2) -0.15719 0.05913           60.4</span></span>
<span><span class="co">#&gt; educ      -0.16744 0.05778           60.1</span></span>
<span><span class="co">#&gt; black     -0.10826 0.06173           91.0</span></span>
<span><span class="co">#&gt; I(re74^2)  0.00465 0.14696           86.7</span></span>
<span><span class="co">#&gt; u75       -0.13870 0.00559           89.3</span></span>
<span><span class="co">#&gt; hisp      -0.02879 0.06963           98.3</span></span>
<span><span class="co">#&gt; nodegr    -0.02804 0.09797           93.9</span></span>
<span><span class="co">#&gt; re74      -0.00998 0.16956           77.2</span></span>
<span><span class="co">#&gt; re75      -0.03032 0.15326           78.0</span></span>
<span><span class="co">#&gt; age       -0.11922 0.13713           44.8</span></span>
<span><span class="co">#&gt; married   -0.04474 0.13728           89.6</span></span>
<span><span class="co">#&gt; I(re75^2) -0.04602 0.14852           88.7</span></span>
<span><span class="co">#&gt; I(age^2)  -0.13062 0.13656           49.7</span></span>
<span><span class="co">#&gt; u74       -0.06356 0.14183           81.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="匹配ate" class="level3" data-number="2.6.2"><h3 data-number="2.6.2" class="anchored" data-anchor-id="匹配ate">
<span class="header-section-number">2.6.2</span> 1:1 匹配ATE</h3>
<p>average treatment effect</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rr.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>, </span>
<span>                Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>                X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                M <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                estimand <span class="op">=</span> <span class="st">'ATE'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr.ate</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2013.3 </span></span>
<span><span class="co">#&gt; AI SE......  817.76 </span></span>
<span><span class="co">#&gt; T-stat.....  2.4619 </span></span>
<span><span class="co">#&gt; p.val......  0.013819 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  445 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  756</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="k-匹配-att" class="level3" data-number="2.6.3"><h3 data-number="2.6.3" class="anchored" data-anchor-id="k-匹配-att">
<span class="header-section-number">2.6.3</span> 1:k 匹配 （ATT）</h3>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>,      </span>
<span>             Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>             X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>             M <span class="op">=</span> <span class="fl">1</span>, </span>
<span>             ties <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>             replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>             estimand <span class="op">=</span> <span class="st">'ATT'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr2</span><span class="op">)</span> <span class="co"># The default estimate is ATT here</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2153.3 </span></span>
<span><span class="co">#&gt; AI SE......  825.4 </span></span>
<span><span class="co">#&gt; T-stat.....  2.6088 </span></span>
<span><span class="co">#&gt; p.val......  0.0090858 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  346</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="genetic-matching" class="level3" data-number="2.6.4"><h3 data-number="2.6.4" class="anchored" data-anchor-id="genetic-matching">
<span class="header-section-number">2.6.4</span> Genetic Matching</h3>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">educ</span>, <span class="va">black</span>, <span class="va">hisp</span>, <span class="va">married</span>, <span class="va">nodegr</span>, <span class="va">u74</span>, <span class="va">u75</span>, <span class="va">re75</span>, <span class="va">re74</span><span class="op">)</span></span>
<span></span>
<span><span class="va">BalanceMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">educ</span>, <span class="va">black</span>, <span class="va">hisp</span>, <span class="va">married</span>, <span class="va">nodegr</span>, <span class="va">u74</span>, <span class="va">u75</span>, <span class="va">re75</span>, <span class="va">re74</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re74</span><span class="op">*</span><span class="va">re75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rr.gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/GenMatch.html">GenMatch</a></span><span class="op">(</span>Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                   X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                   BalanceMatrix <span class="op">=</span> <span class="va">BalanceMat</span>,</span>
<span>                   estimand <span class="op">=</span> <span class="st">'ATE'</span>, </span>
<span>                   M <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                   pop.size <span class="op">=</span> <span class="fl">16</span>,</span>
<span>                   print.level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">rr.gen.mout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>, </span>
<span>                     Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>                     X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>                     estimand <span class="op">=</span> <span class="st">'ATE'</span>,</span>
<span>                     Weight.matrix <span class="op">=</span> <span class="va">rr.gen</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr.gen.mout</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2072.8 </span></span>
<span><span class="co">#&gt; AI SE......  810.91 </span></span>
<span><span class="co">#&gt; T-stat.....  2.5562 </span></span>
<span><span class="co">#&gt; p.val......  0.010584 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  445 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  586</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Partial exact matching</span></span>
<span><span class="va">rr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Matchby.html">Matchby</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>, </span>
<span>               Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>               X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>, </span>
<span>               by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">nodegr</span><span class="op">)</span>,</span>
<span>               print.level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2336.6 </span></span>
<span><span class="co">#&gt; SE.........  671.2 </span></span>
<span><span class="co">#&gt; T-stat.....  3.4812 </span></span>
<span><span class="co">#&gt; p.val......  0.00049917 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  185</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Partial exact matching on two covariates</span></span>
<span><span class="va">rr3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Matchby.html">Matchby</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>, </span>
<span>               Tr <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>               X <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">ps</span>, </span>
<span>               by <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'nodegr'</span>,<span class="st">'married'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>               print.level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rr3</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  1560.5 </span></span>
<span><span class="co">#&gt; SE.........  714.64 </span></span>
<span><span class="co">#&gt; T-stat.....  2.1836 </span></span>
<span><span class="co">#&gt; p.val......  0.028991 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  185</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="match版" class="level3" data-number="2.6.5"><h3 data-number="2.6.5" class="anchored" data-anchor-id="match版">
<span class="header-section-number">2.6.5</span> <code>Match()</code>版</h3>
<section id="倾向匹配" class="level4" data-number="2.6.5.1"><h4 data-number="2.6.5.1" class="anchored" data-anchor-id="倾向匹配">
<span class="header-section-number">2.6.5.1</span> 倾向匹配</h4>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span></span>
<span><span class="va">glm_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span> <span class="va">hisp</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegr</span> <span class="op">+</span> <span class="va">re74</span>  <span class="op">+</span> <span class="va">re75</span>,</span>
<span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">psm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">re78</span>,</span>
<span>             Tr <span class="op">=</span> <span class="va">treat</span>,</span>
<span>             X<span class="op">=</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span>,</span>
<span>             estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>             M<span class="op">=</span><span class="fl">1</span>,</span>
<span>             replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">psm1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2624.3 </span></span>
<span><span class="co">#&gt; AI SE......  802.19 </span></span>
<span><span class="co">#&gt; T-stat.....  3.2714 </span></span>
<span><span class="co">#&gt; p.val......  0.0010702 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  344</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>如上所示，使用1对1样本可替代匹配法，实验组平均效应为2624.3，因果效应的标准误为803.19，t值为3.2714，p值为0.0010702&lt;0.05，表明估计的实验组平均处理效应有统计学差异。</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">psm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">re78</span>,</span>
<span>             Tr <span class="op">=</span> <span class="va">treat</span>,</span>
<span>             X<span class="op">=</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span>,</span>
<span>             estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>             M<span class="op">=</span><span class="fl">1</span>,</span>
<span>             replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">psm2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  1858.8 </span></span>
<span><span class="co">#&gt; SE.........  654.15 </span></span>
<span><span class="co">#&gt; T-stat.....  2.8416 </span></span>
<span><span class="co">#&gt; p.val......  0.0044892 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  185</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="平衡诊断-1" class="level4" data-number="2.6.5.2"><h4 data-number="2.6.5.2" class="anchored" data-anchor-id="平衡诊断-1">
<span class="header-section-number">2.6.5.2</span> 平衡诊断</h4>
<p>受试者个体同质性，是否随机分配</p>
<p>协变量分布是否平衡，是否重合：</p>
<p>以<code>age</code> 为例，实验组匹配前25.816匹配后25.816，对照组匹配前25.054匹配后25.692 ，匹配后实验组与对照组更接近了；T-test p-value &gt; 0.05 ，表示匹配前后<code>age</code> 均值无统计学差异；KS Bootstrap p-value &gt; 0.05 ，表示匹配前后<code>age</code> 分布无统计学差异</p>
<pre><code>***** (V1) age *****                Before Matching          After Matching 

mean   treatment........          25.816             25.816  
mean control..........     25.054            25.692 
std mean diff.........     10.655            1.7342 

mean raw eQQ diff.....    0.94054           0.73837  
med  raw eQQ diff.....          1                 0  
max  raw eQQ diff.....          7                 9   

mean eCDF diff........   0.025364          0.021893  
med  eCDF diff........   0.022193          0.020349  
max  eCDF diff........   0.065177          0.061047   

var ratio (Tr/Co).....     1.0278             1.083  
T-test p-value........    0.26594           0.84975  
KS Bootstrap p-value..      0.526             0.355  
KS Naive p-value......     0.7481           0.54314  
KS Statistic..........   0.065177          0.061047 </code></pre>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">check_balance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/MatchBalance.html">MatchBalance</a></span><span class="op">(</span></span>
<span>    formul <span class="op">=</span> <span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span> <span class="va">hisp</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegr</span> <span class="op">+</span> <span class="va">re74</span>  <span class="op">+</span> <span class="va">re75</span>,</span>
<span>    match.out <span class="op">=</span> <span class="va">psm1</span>,</span>
<span>    nboots <span class="op">=</span> <span class="fl">1000</span>,data <span class="op">=</span> <span class="va">lalonde</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V1) age *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     25.816             25.816 </span></span>
<span><span class="co">#&gt; mean control..........     25.054             25.692 </span></span>
<span><span class="co">#&gt; std mean diff.........     10.655             1.7342 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....    0.94054            0.73837 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          1                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          7                  9 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.025364           0.021893 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.022193           0.020349 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.065177           0.061047 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.0278              1.083 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.26594            0.84975 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.527              0.374 </span></span>
<span><span class="co">#&gt; KS Naive p-value......     0.7481            0.54314 </span></span>
<span><span class="co">#&gt; KS Statistic..........   0.065177           0.061047 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V2) educ *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     10.346             10.346 </span></span>
<span><span class="co">#&gt; mean control..........     10.088             10.146 </span></span>
<span><span class="co">#&gt; std mean diff.........     12.806             9.9664 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....    0.40541            0.23256 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          2                  2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.028698           0.016611 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.012682           0.010174 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.12651           0.061047 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.5513             1.2344 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.15017             0.1842 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.015              0.211 </span></span>
<span><span class="co">#&gt; KS Naive p-value......   0.062873            0.54314 </span></span>
<span><span class="co">#&gt; KS Statistic..........    0.12651           0.061047 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V3) black *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........    0.84324            0.84324 </span></span>
<span><span class="co">#&gt; mean control..........    0.82692            0.86847 </span></span>
<span><span class="co">#&gt; std mean diff.........     4.4767            -6.9194 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....   0.016216           0.026163 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........  0.0081601           0.013081 </span></span>
<span><span class="co">#&gt; med  eCDF diff........  0.0081601           0.013081 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.01632           0.026163 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....    0.92503             1.1572 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.64736            0.40214 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V4) hisp *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........   0.059459           0.059459 </span></span>
<span><span class="co">#&gt; mean control..........    0.10769            0.04955 </span></span>
<span><span class="co">#&gt; std mean diff.........    -20.341             4.1792 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....   0.048649           0.011628 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.024116           0.005814 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.024116           0.005814 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.048233           0.011628 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....    0.58288             1.1875 </span></span>
<span><span class="co">#&gt; T-test p-value........   0.064043            0.46063 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V5) married *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........    0.18919            0.18919 </span></span>
<span><span class="co">#&gt; mean control..........    0.15385            0.18423 </span></span>
<span><span class="co">#&gt; std mean diff.........     8.9995             1.2617 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....   0.037838           0.026163 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.017672           0.013081 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.017672           0.013081 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.035343           0.026163 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.1802             1.0207 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.33425            0.89497 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V6) nodegr *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........    0.70811            0.70811 </span></span>
<span><span class="co">#&gt; mean control..........    0.83462            0.76757 </span></span>
<span><span class="co">#&gt; std mean diff.........    -27.751            -13.043 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....    0.12432           0.043605 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.063254           0.021802 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.063254           0.021802 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.12651           0.043605 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.4998             1.1585 </span></span>
<span><span class="co">#&gt; T-test p-value........  0.0020368          0.0071385 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V7) re74 *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     2095.6             2095.6 </span></span>
<span><span class="co">#&gt; mean control..........       2107             2193.3 </span></span>
<span><span class="co">#&gt; std mean diff.........   -0.23437            -2.0004 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....     487.98             869.16 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....       8413              10305 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.019223           0.054701 </span></span>
<span><span class="co">#&gt; med  eCDF diff........     0.0158           0.050872 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.047089            0.12209 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     0.7381            0.75054 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.98186            0.84996 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.571              0.001 </span></span>
<span><span class="co">#&gt; KS Naive p-value......    0.97023           0.011858 </span></span>
<span><span class="co">#&gt; KS Statistic..........   0.047089            0.12209 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V8) re75 *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     1532.1             1532.1 </span></span>
<span><span class="co">#&gt; mean control..........     1266.9             2179.9 </span></span>
<span><span class="co">#&gt; std mean diff.........     8.2363            -20.125 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....     367.61             590.34 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....     2110.2             8092.9 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.050834           0.050338 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.061954           0.049419 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.10748           0.098837 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.0763            0.56563 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.38527           0.079002 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.049              0.013 </span></span>
<span><span class="co">#&gt; KS Naive p-value......    0.16449           0.069435 </span></span>
<span><span class="co">#&gt; KS Statistic..........    0.10748           0.098837 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Before Matching Minimum p.value: 0.0020368 </span></span>
<span><span class="co">#&gt; Variable Name(s): nodegr  Number(s): 6 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; After Matching Minimum p.value: 0.001 </span></span>
<span><span class="co">#&gt; Variable Name(s): re74  Number(s): 7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># age 变平衡了</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html">qqplot</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">psm1</span><span class="op">$</span><span class="va">index.control</span><span class="op">]</span>,<span class="va">lalonde</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">psm1</span><span class="op">$</span><span class="va">index.treated</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># re74 更不平衡了</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html">qqplot</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">re74</span><span class="op">[</span><span class="va">psm1</span><span class="op">$</span><span class="va">index.control</span><span class="op">]</span>,<span class="va">lalonde</span><span class="op">$</span><span class="va">re74</span><span class="op">[</span><span class="va">psm1</span><span class="op">$</span><span class="va">index.treated</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-36-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># # The covariates we want to match on</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">age</span> , <span class="va">educ</span> , <span class="va">black</span> , <span class="va">hisp</span> , <span class="va">married</span> , <span class="va">nodegr</span> , <span class="va">re74</span>  , <span class="va">re75</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The covariates we want to obtain balance on</span></span>
<span><span class="va">BalanceMatrix</span> <span class="op">=</span> <span class="va">x</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Genetic Matching 自动适配平衡</span></span>
<span><span class="va">gen_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/GenMatch.html">GenMatch</a></span><span class="op">(</span>Tr<span class="op">=</span><span class="va">treat</span>,</span>
<span>                      X<span class="op">=</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span>,</span>
<span>                      BalanceMatrix <span class="op">=</span> <span class="va">x</span>,</span>
<span>                      estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Wed Sep 11 20:25:16 2024</span></span>
<span><span class="co">#&gt; Domains:</span></span>
<span><span class="co">#&gt;  0.000000e+00   &lt;=  X1   &lt;=    1.000000e+03 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data Type: Floating Point</span></span>
<span><span class="co">#&gt; Operators (code number, name, population) </span></span>
<span><span class="co">#&gt;  (1) Cloning...........................  15</span></span>
<span><span class="co">#&gt;  (2) Uniform Mutation..................  12</span></span>
<span><span class="co">#&gt;  (3) Boundary Mutation.................  12</span></span>
<span><span class="co">#&gt;  (4) Non-Uniform Mutation..............  12</span></span>
<span><span class="co">#&gt;  (5) Polytope Crossover................  12</span></span>
<span><span class="co">#&gt;  (6) Simple Crossover..................  12</span></span>
<span><span class="co">#&gt;  (7) Whole Non-Uniform Mutation........  12</span></span>
<span><span class="co">#&gt;  (8) Heuristic Crossover...............  12</span></span>
<span><span class="co">#&gt;  (9) Local-Minimum Crossover...........  0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SOFT Maximum Number of Generations: 100</span></span>
<span><span class="co">#&gt; Maximum Nonchanging Generations: 4</span></span>
<span><span class="co">#&gt; Population size       : 100</span></span>
<span><span class="co">#&gt; Convergence Tolerance: 1.000000e-03</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Not Using the BFGS Derivative Based Optimizer on the Best Individual Each Generation.</span></span>
<span><span class="co">#&gt; Not Checking Gradients before Stopping.</span></span>
<span><span class="co">#&gt; Using Out of Bounds Individuals.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Maximization Problem.</span></span>
<span><span class="co">#&gt; GENERATION: 0 (initializing the population)</span></span>
<span><span class="co">#&gt; Lexical Fit..... 1.180299e-02  1.180299e-02  1.155612e-01  1.186261e-01  1.822343e-01  3.842491e-01  3.842491e-01  4.144313e-01  4.144313e-01  4.610718e-01  5.977650e-01  7.731052e-01  7.731052e-01  8.523060e-01  9.184104e-01  9.749549e-01  </span></span>
<span><span class="co">#&gt; #unique......... 100, #Total UniqueCount: 100</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 3.729259e+01</span></span>
<span><span class="co">#&gt; mean............ 4.810920e+02</span></span>
<span><span class="co">#&gt; variance........ 7.636997e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 1</span></span>
<span><span class="co">#&gt; Lexical Fit..... 1.180299e-02  1.180299e-02  1.155612e-01  1.186261e-01  1.822343e-01  3.842491e-01  3.842491e-01  4.144313e-01  4.144313e-01  4.610718e-01  5.977650e-01  7.731052e-01  7.731052e-01  8.523060e-01  9.184104e-01  9.749549e-01  </span></span>
<span><span class="co">#&gt; #unique......... 61, #Total UniqueCount: 161</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 3.729259e+01</span></span>
<span><span class="co">#&gt; mean............ 2.015230e+02</span></span>
<span><span class="co">#&gt; variance........ 6.039634e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 2</span></span>
<span><span class="co">#&gt; Lexical Fit..... 1.180299e-02  1.180299e-02  1.155612e-01  1.186261e-01  1.822343e-01  3.842491e-01  3.842491e-01  4.144313e-01  4.144313e-01  4.610718e-01  5.977650e-01  7.731052e-01  7.731052e-01  8.523060e-01  9.184104e-01  9.749549e-01  </span></span>
<span><span class="co">#&gt; #unique......... 56, #Total UniqueCount: 217</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 3.729259e+01</span></span>
<span><span class="co">#&gt; mean............ 9.873041e+01</span></span>
<span><span class="co">#&gt; variance........ 3.291501e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 3</span></span>
<span><span class="co">#&gt; Lexical Fit..... 1.180299e-02  1.180299e-02  1.155612e-01  1.186261e-01  1.822343e-01  3.842491e-01  3.842491e-01  4.144313e-01  4.144313e-01  4.610718e-01  5.977650e-01  7.731052e-01  7.731052e-01  8.523060e-01  9.184104e-01  9.749549e-01  </span></span>
<span><span class="co">#&gt; #unique......... 56, #Total UniqueCount: 273</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 3.729259e+01</span></span>
<span><span class="co">#&gt; mean............ 1.042351e+02</span></span>
<span><span class="co">#&gt; variance........ 2.899583e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 4</span></span>
<span><span class="co">#&gt; Lexical Fit..... 1.180299e-02  1.180299e-02  1.155612e-01  1.186261e-01  1.822343e-01  3.842491e-01  3.842491e-01  4.144313e-01  4.144313e-01  4.610718e-01  5.977650e-01  7.731052e-01  7.731052e-01  8.523060e-01  9.184104e-01  9.749549e-01  </span></span>
<span><span class="co">#&gt; #unique......... 58, #Total UniqueCount: 331</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 3.729259e+01</span></span>
<span><span class="co">#&gt; mean............ 1.050645e+02</span></span>
<span><span class="co">#&gt; variance........ 2.721152e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 5</span></span>
<span><span class="co">#&gt; Lexical Fit..... 1.541148e-02  2.397991e-02  2.418950e-02  2.418950e-02  1.729273e-01  1.956942e-01  3.942807e-01  3.942807e-01  6.059370e-01  6.059370e-01  6.074259e-01  6.137460e-01  8.414918e-01  8.538318e-01  9.621995e-01  9.621995e-01  </span></span>
<span><span class="co">#&gt; #unique......... 58, #Total UniqueCount: 389</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 2.941808e-01</span></span>
<span><span class="co">#&gt; mean............ 8.418536e+01</span></span>
<span><span class="co">#&gt; variance........ 1.578216e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 6</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.145421e-02  4.145421e-02  4.499068e-02  4.499068e-02  1.608408e-01  1.806532e-01  2.764640e-01  4.729068e-01  4.729068e-01  6.940013e-01  6.940013e-01  7.762162e-01  8.635587e-01  8.667712e-01  8.667712e-01  9.507460e-01  </span></span>
<span><span class="co">#&gt; #unique......... 62, #Total UniqueCount: 451</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 7.310932e-02</span></span>
<span><span class="co">#&gt; mean............ 9.403781e+01</span></span>
<span><span class="co">#&gt; variance........ 2.447312e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 7</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.177047e-02  4.177047e-02  4.419097e-02  6.248288e-02  1.198352e-01  2.880778e-01  3.513309e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.836843e-01  8.920699e-01  8.920699e-01  </span></span>
<span><span class="co">#&gt; #unique......... 61, #Total UniqueCount: 512</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 8.760968e-02</span></span>
<span><span class="co">#&gt; mean............ 1.016562e+02</span></span>
<span><span class="co">#&gt; variance........ 4.437002e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 8</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.177047e-02  4.177047e-02  4.559074e-02  6.427954e-02  1.215371e-01  2.846955e-01  3.519026e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.794500e-01  8.948772e-01  8.948772e-01  </span></span>
<span><span class="co">#&gt; #unique......... 60, #Total UniqueCount: 572</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 8.627748e-02</span></span>
<span><span class="co">#&gt; mean............ 7.473970e+01</span></span>
<span><span class="co">#&gt; variance........ 2.676016e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 9</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.177047e-02  4.177047e-02  4.559074e-02  6.427954e-02  1.215371e-01  2.846955e-01  3.519026e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.794500e-01  8.948772e-01  8.948772e-01  </span></span>
<span><span class="co">#&gt; #unique......... 55, #Total UniqueCount: 627</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 8.627748e-02</span></span>
<span><span class="co">#&gt; mean............ 4.192386e+01</span></span>
<span><span class="co">#&gt; variance........ 1.737331e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 10</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.177047e-02  4.177047e-02  4.559074e-02  6.427954e-02  1.215371e-01  2.846955e-01  3.519026e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.794500e-01  8.948772e-01  8.948772e-01  </span></span>
<span><span class="co">#&gt; #unique......... 51, #Total UniqueCount: 678</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 8.627748e-02</span></span>
<span><span class="co">#&gt; mean............ 6.242257e+01</span></span>
<span><span class="co">#&gt; variance........ 2.722981e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 11</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.177047e-02  4.177047e-02  4.559074e-02  6.427954e-02  1.215371e-01  2.846955e-01  3.519026e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.794500e-01  8.948772e-01  8.948772e-01  </span></span>
<span><span class="co">#&gt; #unique......... 49, #Total UniqueCount: 727</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 8.627748e-02</span></span>
<span><span class="co">#&gt; mean............ 5.280735e+01</span></span>
<span><span class="co">#&gt; variance........ 1.784927e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 12</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.177047e-02  4.177047e-02  4.559074e-02  6.427954e-02  1.215371e-01  2.846955e-01  3.519026e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.794500e-01  8.948772e-01  8.948772e-01  </span></span>
<span><span class="co">#&gt; #unique......... 50, #Total UniqueCount: 777</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 8.627748e-02</span></span>
<span><span class="co">#&gt; mean............ 5.682777e+01</span></span>
<span><span class="co">#&gt; variance........ 2.131922e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GENERATION: 13</span></span>
<span><span class="co">#&gt; Lexical Fit..... 4.177047e-02  4.177047e-02  4.559074e-02  6.427954e-02  1.215371e-01  2.846955e-01  3.519026e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.794500e-01  8.948772e-01  8.948772e-01  </span></span>
<span><span class="co">#&gt; #unique......... 53, #Total UniqueCount: 830</span></span>
<span><span class="co">#&gt; var 1:</span></span>
<span><span class="co">#&gt; best............ 8.627748e-02</span></span>
<span><span class="co">#&gt; mean............ 3.877940e+01</span></span>
<span><span class="co">#&gt; variance........ 1.599211e+04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 'wait.generations' limit reached.</span></span>
<span><span class="co">#&gt; No significant improvement in 4 generations.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution Lexical Fitness Value:</span></span>
<span><span class="co">#&gt; 4.177047e-02  4.177047e-02  4.559074e-02  6.427954e-02  1.215371e-01  2.846955e-01  3.519026e-01  4.150287e-01  4.150287e-01  8.316757e-01  8.316757e-01  8.667712e-01  8.667712e-01  8.794500e-01  8.948772e-01  8.948772e-01  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameters at the Solution:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  X[ 1] : 8.627748e-02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution Found Generation 8</span></span>
<span><span class="co">#&gt; Number of Generations Run 13</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Wed Sep 11 20:25:22 2024</span></span>
<span><span class="co">#&gt; Total run time : 0 hours 0 minutes and 6 seconds</span></span>
<span></span>
<span><span class="va">psM</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">re78</span>,</span>
<span>             Tr <span class="op">=</span> <span class="va">treat</span>,</span>
<span>             X<span class="op">=</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span>,</span>
<span>             estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>             Weight.matrix <span class="op">=</span> <span class="va">gen_match</span>,</span>
<span>             replace <span class="op">=</span> <span class="cn">TRUE</span>,<span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">psM</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2439.3 </span></span>
<span><span class="co">#&gt; AI SE......  813.4 </span></span>
<span><span class="co">#&gt; T-stat.....  2.9989 </span></span>
<span><span class="co">#&gt; p.val......  0.0027099 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  489</span></span>
<span></span>
<span><span class="va">check_balance2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/MatchBalance.html">MatchBalance</a></span><span class="op">(</span></span>
<span>    formul <span class="op">=</span> <span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span> <span class="va">hisp</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegr</span> <span class="op">+</span> <span class="va">re74</span>  <span class="op">+</span> <span class="va">re75</span>,</span>
<span>    match.out <span class="op">=</span> <span class="va">psM</span>,</span>
<span>    nboots <span class="op">=</span> <span class="fl">1000</span>,data <span class="op">=</span> <span class="va">lalonde</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V1) age *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     25.816             25.816 </span></span>
<span><span class="co">#&gt; mean control..........     25.054             25.217 </span></span>
<span><span class="co">#&gt; std mean diff.........     10.655             8.3769 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....    0.94054            0.46217 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          1                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          7                  9 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.025364           0.012952 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.022193           0.010225 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.065177            0.03681 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.0278             1.2224 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.26594             0.3519 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.503              0.734 </span></span>
<span><span class="co">#&gt; KS Naive p-value......     0.7481            0.89488 </span></span>
<span><span class="co">#&gt; KS Statistic..........   0.065177            0.03681 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V2) educ *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     10.346             10.346 </span></span>
<span><span class="co">#&gt; mean control..........     10.088             10.188 </span></span>
<span><span class="co">#&gt; std mean diff.........     12.806             7.8605 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....    0.40541            0.17587 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          2                  2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.028698           0.012562 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.012682           0.010225 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.12651            0.03681 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.5513             1.2791 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.15017             0.2847 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.011              0.456 </span></span>
<span><span class="co">#&gt; KS Naive p-value......   0.062873            0.89488 </span></span>
<span><span class="co">#&gt; KS Statistic..........    0.12651            0.03681 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V3) black *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........    0.84324            0.84324 </span></span>
<span><span class="co">#&gt; mean control..........    0.82692              0.868 </span></span>
<span><span class="co">#&gt; std mean diff.........     4.4767            -6.7917 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....   0.016216           0.034765 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........  0.0081601           0.017382 </span></span>
<span><span class="co">#&gt; med  eCDF diff........  0.0081601           0.017382 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.01632           0.034765 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....    0.92503             1.1537 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.64736            0.41503 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V4) hisp *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........   0.059459           0.059459 </span></span>
<span><span class="co">#&gt; mean control..........    0.10769           0.057132 </span></span>
<span><span class="co">#&gt; std mean diff.........    -20.341            0.98148 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....   0.048649            0.00818 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.024116            0.00409 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.024116            0.00409 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.048233            0.00818 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....    0.58288             1.0382 </span></span>
<span><span class="co">#&gt; T-test p-value........   0.064043            0.86677 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V5) married *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........    0.18919            0.18919 </span></span>
<span><span class="co">#&gt; mean control..........    0.15385            0.18101 </span></span>
<span><span class="co">#&gt; std mean diff.........     8.9995             2.0837 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....   0.037838           0.018405 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.017672          0.0092025 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.017672          0.0092025 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.035343           0.018405 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.1802             1.0348 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.33425            0.83168 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V6) nodegr *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........    0.70811            0.70811 </span></span>
<span><span class="co">#&gt; mean control..........    0.83462            0.75333 </span></span>
<span><span class="co">#&gt; std mean diff.........    -27.751            -9.9207 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....    0.12432           0.034765 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....          1                  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.063254           0.017382 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.063254           0.017382 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.12651           0.034765 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.4998             1.1123 </span></span>
<span><span class="co">#&gt; T-test p-value........  0.0020368            0.04177 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V7) re74 *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     2095.6             2095.6 </span></span>
<span><span class="co">#&gt; mean control..........       2107             2018.1 </span></span>
<span><span class="co">#&gt; std mean diff.........   -0.23437             1.5857 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....     487.98             648.91 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....       8413              10305 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.019223           0.037077 </span></span>
<span><span class="co">#&gt; med  eCDF diff........     0.0158           0.033742 </span></span>
<span><span class="co">#&gt; max  eCDF diff........   0.047089           0.087935 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     0.7381            0.86668 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.98186            0.87945 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.555              0.002 </span></span>
<span><span class="co">#&gt; KS Naive p-value......    0.97023           0.045591 </span></span>
<span><span class="co">#&gt; KS Statistic..........   0.047089           0.087935 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***** (V8) re75 *****</span></span>
<span><span class="co">#&gt;                        Before Matching        After Matching</span></span>
<span><span class="co">#&gt; mean treatment........     1532.1             1532.1 </span></span>
<span><span class="co">#&gt; mean control..........     1266.9             2079.5 </span></span>
<span><span class="co">#&gt; std mean diff.........     8.2363            -17.005 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean raw eQQ diff.....     367.61             532.46 </span></span>
<span><span class="co">#&gt; med  raw eQQ diff.....          0                  0 </span></span>
<span><span class="co">#&gt; max  raw eQQ diff.....     2110.2             8092.9 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; mean eCDF diff........   0.050834           0.040137 </span></span>
<span><span class="co">#&gt; med  eCDF diff........   0.061954             0.0409 </span></span>
<span><span class="co">#&gt; max  eCDF diff........    0.10748           0.083845 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; var ratio (Tr/Co).....     1.0763            0.64518 </span></span>
<span><span class="co">#&gt; T-test p-value........    0.38527            0.12154 </span></span>
<span><span class="co">#&gt; KS Bootstrap p-value..      0.038               0.02 </span></span>
<span><span class="co">#&gt; KS Naive p-value......    0.16449            0.06428 </span></span>
<span><span class="co">#&gt; KS Statistic..........    0.10748           0.083845 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Before Matching Minimum p.value: 0.0020368 </span></span>
<span><span class="co">#&gt; Variable Name(s): nodegr  Number(s): 6 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; After Matching Minimum p.value: 0.002 </span></span>
<span><span class="co">#&gt; Variable Name(s): re74  Number(s): 7</span></span>
<span></span>
<span><span class="co"># age 变平衡了</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html">qqplot</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.control</span><span class="op">]</span>,<span class="va">lalonde</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.treated</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># re74 也变平衡了</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html">qqplot</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">re74</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.control</span><span class="op">]</span>,<span class="va">lalonde</span><span class="op">$</span><span class="va">re74</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.treated</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="matching_files/figure-html/unnamed-chunk-37-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="overlap" class="level4" data-number="2.6.5.3"><h4 data-number="2.6.5.3" class="anchored" data-anchor-id="overlap">
<span class="header-section-number">2.6.5.3</span> overlap</h4>
</section><section id="共同支持域的查验" class="level4" data-number="2.6.5.4"><h4 data-number="2.6.5.4" class="anchored" data-anchor-id="共同支持域的查验">
<span class="header-section-number">2.6.5.4</span> 共同支持域的查验</h4>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">[</span><span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">&gt;</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">[</span><span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">[</span><span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">&lt;</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">[</span><span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>丢弃的实验组样本共有4个。185-181</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">psM</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2439.3 </span></span>
<span><span class="co">#&gt; AI SE......  813.4 </span></span>
<span><span class="co">#&gt; T-stat.....  2.9989 </span></span>
<span><span class="co">#&gt; p.val......  0.0027099 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  445 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  185 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  489</span></span>
<span><span class="va">psM_CS</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">re78</span>,</span>
<span>             Tr <span class="op">=</span> <span class="va">treat</span>,</span>
<span>             X<span class="op">=</span><span class="va">glm_ps</span><span class="op">$</span><span class="va">fitted.values</span>,</span>
<span>             estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>             Weight.matrix <span class="op">=</span> <span class="va">gen_match</span>,</span>
<span>             replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>             CommonSupport <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">psM_CS</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate...  2330 </span></span>
<span><span class="co">#&gt; AI SE......  821.6 </span></span>
<span><span class="co">#&gt; T-stat.....  2.836 </span></span>
<span><span class="co">#&gt; p.val......  0.0045684 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original number of observations..............  430 </span></span>
<span><span class="co">#&gt; Original number of treated obs...............  181 </span></span>
<span><span class="co">#&gt; Matched number of observations...............  181 </span></span>
<span><span class="co">#&gt; Matched number of observations  (unweighted).  468</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>有查验共同支持域的ATT（2330），与无查验共同支持域（2439.3）存在差异，因此必须重新改进倾向值分析。</p>
</section><section id="敏感性分析-1" class="level4" data-number="2.6.5.5"><h4 data-number="2.6.5.5" class="anchored" data-anchor-id="敏感性分析-1">
<span class="header-section-number">2.6.5.5</span> 敏感性分析</h4>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rbounds</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rbounds/man/psens.html">psens</a></span><span class="op">(</span>x <span class="op">=</span><span class="va">lalonde</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.treated</span>,<span class="st">"re78"</span><span class="op">]</span>,</span>
<span>      y <span class="op">=</span><span class="va">lalonde</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.control</span>,<span class="st">"re78"</span><span class="op">]</span> ,</span>
<span>      Gamma <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      GammaInc <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Rosenbaum Sensitivity Test for Wilcoxon Signed Rank P-Value </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Unconfounded estimate ....  1e-04 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Gamma Lower bound Upper bound</span></span>
<span><span class="co">#&gt;    1.0       1e-04      0.0001</span></span>
<span><span class="co">#&gt;    1.1       0e+00      0.0015</span></span>
<span><span class="co">#&gt;    1.2       0e+00      0.0142</span></span>
<span><span class="co">#&gt;    1.3       0e+00      0.0693</span></span>
<span><span class="co">#&gt;    1.4       0e+00      0.2048</span></span>
<span><span class="co">#&gt;    1.5       0e+00      0.4152</span></span>
<span><span class="co">#&gt;    1.6       0e+00      0.6393</span></span>
<span><span class="co">#&gt;    1.7       0e+00      0.8140</span></span>
<span><span class="co">#&gt;    1.8       0e+00      0.9191</span></span>
<span><span class="co">#&gt;    1.9       0e+00      0.9699</span></span>
<span><span class="co">#&gt;    2.0       0e+00      0.9903</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Note: Gamma is Odds of Differential Assignment To</span></span>
<span><span class="co">#&gt;  Treatment Due to Unobserved Factors </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co"># psens</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>对<code>psM（Y=re78）</code>使用<code><a href="https://rdrr.io/pkg/rbounds/man/psens.html">psens()</a></code>进行Wilcoxon 符合秩检验，当τ=1.3，p值就大于0.05了，说明处理发生比为1.3时，就可以改变原先对于处理效应的结论，也就是说，这个隐藏性偏差不必太大就可以改变原来的结论，因此分析结果对隐藏性排除的影响非常敏感，结论不可靠。</p>
<p>对 <code>psM（Y=re78）</code>使用Hodges-Lehmann点估计检验法 <code><a href="https://rdrr.io/pkg/rbounds/man/hlsens.html">hlsens()</a></code> ，当τ=1.5，其95%置信区间包含零，说明此时处理效应是无效的。说明处理发生比为1.5时，隐藏性偏差就可以改变原来的结论，因此匹配后的结论不可靠。</p>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.treated</span>, <span class="st">"re78"</span><span class="op">]</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span><span class="va">psM</span><span class="op">$</span><span class="va">index.control</span>, <span class="st">"re78"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rbounds/man/hlsens.html">hlsens</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>,Gamma <span class="op">=</span> <span class="fl">2</span>,GammaInc <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Rosenbaum Sensitivity Test for Hodges-Lehmann Point Estimate </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Unconfounded estimate ....  1527.95 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Gamma Lower bound Upper bound</span></span>
<span><span class="co">#&gt;    1.0 1527.900000      1527.9</span></span>
<span><span class="co">#&gt;    1.1  917.250000      1580.2</span></span>
<span><span class="co">#&gt;    1.2  608.050000      1918.7</span></span>
<span><span class="co">#&gt;    1.3  338.450000      2141.0</span></span>
<span><span class="co">#&gt;    1.4  114.850000      2407.3</span></span>
<span><span class="co">#&gt;    1.5   -0.050046      2631.4</span></span>
<span><span class="co">#&gt;    1.6 -154.050000      2850.3</span></span>
<span><span class="co">#&gt;    1.7 -378.150000      3072.7</span></span>
<span><span class="co">#&gt;    1.8 -545.350000      3258.1</span></span>
<span><span class="co">#&gt;    1.9 -706.350000      3474.2</span></span>
<span><span class="co">#&gt;    2.0 -867.650000      3678.9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Note: Gamma is Odds of Differential Assignment To</span></span>
<span><span class="co">#&gt;  Treatment Due to Unobserved Factors </span></span>
<span><span class="co">#&gt; </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./PSM.html" class="pagination-link" aria-label="PSM">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">PSM</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./stratification.html" class="pagination-link" aria-label="分层（Stratification）">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">分层（Stratification）</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>