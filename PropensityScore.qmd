# 倾向性评分 {.unnumbered}

[Applied Propensity Score Analysis with R](https://psa.bryer.org/index.html)

<https://ehsanx.github.io/EpiMethods/propensityscore.html>

倾向性评分最大的优势是将多个混杂因素的多维影响用一维的倾向值（接受某处理的概率）来表示，即**倾向性评分值（Propensity Score, PS）**，从而降低协变量的维度，因此该方法尤其适用于协变量较多的情况。

```{r eval=FALSE}
if(!require(psa)) remotes::install_github('jbryer/psa', dependencies = 'Enhances')
```

## 分类

倾向性评分只是一个分数（P值），自己并没有均衡协变量（混杂因素）的能力，利用 PS 值均衡组间协变量分布的方法有**匹配（matching）**、**分层（stratification）**、**协变量调整（covariate adjustment）**和**加权（weighting）**等。其中协变量调整又可以称为倾向性评分回归、倾向性评分矫正等。



## 预处理

用于倾向性评分的数据要进行一些预处理，比如因子化 和 **缺失值处理** 如算法插补（KNN、随机森林等），

## 流程

倾向性评分的一般步骤为：

1.  **选择倾向得分估计模型**

    a.  估计倾向得分：倾向得分是给定一组观察到的 covaraites 接受治疗、干预或暴露的条件概率 。PS 值的估计是**以处理因素作为因变量，其他混杂因素作为自变量**，通过建立一个模型来估计每个研究对象接受处理因素的可能性。目前用于估计 PS 值的方法有logistic 回归，分类树，Probit 回归、Bootstrapping、随机森林等。其中 logistic 回归是目前最常用的方法。

    b.  平衡诊断 balance diagnosis：对于处理单元和对照单元成对的匹配方法，可以使用相关样本检验（例如，连续变量的 t 检验和分类变量的卡方检验），但是犯 I 类和 II 类错误的可能性非常高。

    `PSAgraphics`标准化的效应大小和图形表示，建议effect sizes小于 0.1。 连续变量的平衡诊断箱线图，分类变量的条形图

    c.  重复前2步，直到优化足够的平衡

2.  **估计因果关系**

    *因果关系的反事实模型*

    因果推断的基本难题：***Y=ZY^1^ +(1-Z)Y^0^ , Z=0 或 1***，2个实际结果，2个反事实结果

    个体处理效应：

    $$
    ITE=\tau_i=y_i^1-y_i^0
    $$

    ***Rubin’s Causal Model***

    平均处理效应 Average Treatment Effect (ATE)

    $$
    \widehat {ATE} =E(\tau)=E(Y^1-Y^0)=E(Y^1)-E(Y^0)
    $$

    Average Treatment Effect Among the Treated (ATT)

    $$
    \widehat {ATT} =E(Y^1-Y^0|X=1)=E(Y^1|X=1)-E(Y^0|X=1)
    $$

    Average Treatment Effect Among the Control (ATC)

    $$
    \widehat {ATC} =E(Y^1-Y^0|X=0)=E(Y^1|X=0)-E(Y^0|X=0)
    $$

    **Average Treatment Effect Among the Evenly Matched (ATM)** 专为倾向得分加权开发的相对较新的估计值，但与进行一对一匹配时的估计值密切相关。

    $$
    ATM_d=E(Y_1-Y_0|M_d=1)
    $$

    进行 PSA 之前，将倾向得分（PS）与结果（outcome）根据治疗、干预或暴露（group）作图通常很有帮助。 Loess 回归线散点图

    分五层的倾向得分评估图，相关样本评估图

3.  **敏感性分析：** 检查未观察到的混杂因素confounding factor 的敏感性

    评估因果估计的稳健性

    1.  敏感度分析：仅针对匹配方法进行了明确定义

    2.  自举法：`PSAboot`

![](images/PSA_Flow.png){fig-align="center"}
